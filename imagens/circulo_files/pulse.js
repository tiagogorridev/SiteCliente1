(()=>{var e={488:e=>{var t=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,e.constructor==Array?this.init_by_array(e,e.length):this.init_seed(e)};t.prototype.init_seed=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},t.prototype.init_by_array=function(e,t){var i,r,n;for(this.init_seed(19650218),i=1,r=0,n=this.N>t?this.N:t;n;n--){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&s)>>>16)<<16)+1664525*(65535&s))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(n=this.N-1;n;n--){s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&s)>>>16)<<16)+1566083941*(65535&s))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},t.prototype.random_int=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_seed(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},t.prototype.random_int31=function(){return this.random_int()>>>1},t.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},t.prototype.random=function(){return this.random_int()*(1/4294967296)},t.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},t.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},e.exports=t}},t={};function i(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,i),s.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";class InjectionToken{constructor(e){if(this.key=e,"string"!=typeof e||!e.trim())throw new Error("Invalid InjectionToken name!");this.___=e}}const e=new InjectionToken("Window"),t=new InjectionToken("COOKIE_BC"),r=(new InjectionToken("PERF_HOOKS"),new InjectionToken("PULSE_GLOBALS"),new InjectionToken("STORAGE_SELECTOR")),n=new InjectionToken("UN_PREFIXED_COOKIE_STORAGE"),s=new InjectionToken("PULSE_ROOT_CONFIGURATION"),o=new InjectionToken("DATA_LAYER"),a=new InjectionToken("INTERNAL_DATA_LAYER");class AsyncTask{constructor(e){if(this.completed=!1,this.task=new Promise(((e,t)=>{this.resolveTask=e,this.rejectTask=t})),e){const t=setTimeout((()=>{this.reject(new Error(`AsyncTask timeout after ${e}ms!`))}),e);this.waitUntilResolved().then((()=>clearTimeout(t))).catch((()=>clearTimeout(t)))}}resolve(e){this.completed||(this.completed=!0,this.resolveTask(e))}reject(e){this.completed||(this.completed=!0,this.rejectTask(e))}waitUntilResolved(){return this.task}}class PulseInjector{constructor(e){this.parent=e,this.providers=new Map,this.store=new Map,this.tasks=new Map}register(...e){for(const t of e)this.providers.set(t.provide,t);return this}factory(e){return this.providers.set(e.provide,e),this}get(e){const t=this.getOrCreate(e);return this.isPromise(t)?t:Promise.resolve(t)}getSync(e){const t=this.getOrCreate(e);if(this.isPromise(t)){const t=this.typeName(e);throw new Error(["Cannot instantiate dependency synchronously!",`One of the providers of the dependencies of '${t}' is asynchronous!`].join("\n"))}return t}getOrCreate(e){if(e===PulseInjector)return this;const t=this.store.get(e);if(t)return t;let i=this.tasks.get(e);if(i)return i.waitUntilResolved();i=new AsyncTask;const r=this.providers.get(e);if(!r){if(this.parent)return this.parent.getOrCreate(e);throw new Error(`No provider found for type '${this.typeName(e)}'!`)}const n=this.getDeps(r);if(this.isPromise(n))return this.tasks.set(e,i),n.then((e=>this.createValue(r,e))).then((t=>{this.store.set(e,t),i?.resolve(t),this.tasks.delete(e)})).catch((t=>{this.tasks.delete(e),i?.reject(t)})),i.waitUntilResolved();{const t=this.createValue(r,n);return this.store.set(e,t),t}}createValue(e,t){if(void 0!==e.useValue)return e.useValue;if(e.useClass)return new e.useClass(...t);if(e.useFactory)return e.useFactory(...t);if(this.isClass(e.provide))return new e.provide(...t);{const t=this.typeName(e.provide);throw new Error(`No useClass or useFactory is provided for type '${t}'`)}}getDeps(e){this.checkDeps(e);const t=(Array.isArray(e.deps)?e.deps:[]).map((e=>this.getOrCreate(e))),i=t.some((e=>this.isPromise(e)));return i?Promise.all(t):t}checkDeps(e){const t=Array.isArray(e.deps)?e.deps:[],i=t.map((e=>this.findProvider(e))),r=t.filter(((e,t)=>void 0===i[t]));if(!r.length)return;const n=this.typeName(e.provide),s=i.map((e=>e?this.typeName(e.provide):"?")).join(", "),o=`No provider found for the following tokens: ${r.map((e=>this.typeName(e))).join(", ")}`;throw new Error(`Cannot instantiate dependency '${n}(${s})'!\n\n ${o}`)}findProvider(e){return this.providers.get(e)||this.parent?.findProvider(e)}typeName(e){return e instanceof InjectionToken?`Token(${e.key})`:this.isClass(e)?e.name:String(e)}isClass(e){return e&&"function"==typeof e&&"string"==typeof e.name&&"function"==typeof e.constructor&&e.name}isPromise(e){return"object"==typeof e&&(e instanceof Promise||e.then&&e.catch)}}class ProviderBuilder{constructor(){this.providers=[]}useClass(e,t,i,r){return this.providers.push({provide:e,useClass:t,deps:i,provideInRoot:r}),this}useFactory(e,t,i,r){return this.providers.push({provide:e,useFactory:t,deps:i,provideInRoot:r}),this}useValue(e,t,i){return this.providers.push({provide:e,useValue:t,provideInRoot:i}),this}_getProviders(){return this.providers}}class PulseModule{constructor(){this.imports=[],this.builder=new ProviderBuilder,this.injector=new PulseInjector,this.bootstrapped=!1}import(e){if(e.bootstrapped)throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");return e.parent=this,this.imports.push(e),this}provide(e){const t=e(this.builder);if(!(t&&t instanceof ProviderBuilder))throw new Error("Provide function must return the received ProviderBuilder instance!");return this.builder=t,this}beforeInit(e){if("function"!=typeof e)throw new Error("BeforeInit handler must be a function!");return this.beforeInitHandler=e,this}onInit(e,t){if("function"!=typeof e)throw new Error("OnInit handler must be a function!");if(t&&!Array.isArray(t))throw new Error("OnInit handler dependency list must be an array!");return this.initHandler={provide:"initializer",useFactory:e,deps:t||void 0},this}bootstrapStrict(e){return this.bootstrap(e)}async bootstrap(e){if(this.bootstrapped)throw new Error("PulseModule is already bootstrapped!");if(this.bootstrapped)throw new Error("Cannot bootstrap child module!");if(this.imports.some((e=>e.bootstrapped)))throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");const t=await this.runModulesBeforeInit(e),i=this.getConfigOverride(t),r={provide:s,useValue:i};return this.injector.register(r),await this.initializeModules(e),this.injector}getConfigOverride(e){try{if("undefined"!=typeof window&&window.localStorage?.getItem){const t=window.localStorage.getItem(`${e.storagePrefix}config_override`);if(t){const i=JSON.parse(t);return i&&"object"==typeof i?{...e,...i}:(console.error("Configuration entry must be an object!"),e)}}}catch(t){console.error("Pulse configuration provided through localStorage is invalid!")}return e}async initializeModules(e){const t=[...this.imports,this];for(const r of t)r.configureInjector();const i=t.map((t=>t.runOnInit(e)));await Promise.all(i)}configureInjector(){if(this.parent&&this.imports.length)throw new Error("Deep module imports are not supported yet!");const e=this.parent?.injector,t=e?new PulseInjector(e):this.injector,i=this.builder._getProviders(),r=i.filter((e=>!1!==e.provideInRoot)),n=i.filter((e=>!e.provideInRoot));t.register(...n),e?e.register(...r):r.length&&t.register(...r),this.injector=t}async runModulesBeforeInit(e){const t=await this.runBeforeInit(e),i=this.imports.map((t=>t.runBeforeInit(e)));return{...t,...(await Promise.all(i)).reduce(((e,t)=>({...e,...t})))}}async runBeforeInit(e){try{const t=this.beforeInitHandler?this.beforeInitHandler(e):void 0;return(t instanceof Promise?await t:t)||{}}catch(t){throw console.error("Module beforeInit hook failed!"),t}}async runOnInit(e){try{if(!this.initHandler?.useFactory)return;const t=(this.initHandler.deps||[]).map((e=>this.injector.get(e))),i=await Promise.all(t),r=this.initHandler.useFactory(e,...i);r instanceof Promise&&await r}catch(t){throw console.error(t),console.error("Module onInit hook failed!"),t}}}var c;!function(e){e[e.None=0]="None",e[e.Error=1]="Error",e[e.Warn=2]="Warn",e[e.Info=3]="Info",e[e.Verbose=4]="Verbose"}(c||(c={}));class LoggerService{constructor(e,t){this.storage=e,this.config=t,this.logLevel=c.Warn,this.KEY_LOG_LEVEL="log_level"}level(){return"number"!=typeof this.logLevel&&(this.logLevel=+(this.storage.get(this.KEY_LOG_LEVEL)||0)||this.config.logLevel||0),this.logLevel}setLevel(e){this.logLevel=e,this.storage.set(this.KEY_LOG_LEVEL,String(e))}enabled(e){return e<=this.level()}error(e,...t){this.print(e,c.Error,t)}warn(e,...t){this.print(e,c.Warn,t)}info(e,...t){this.print(e,c.Info,t)}verbose(e,...t){this.print(e,c.Verbose,t)}print(e,t,i){if(this.enabled(t))switch(t){case c.Error:console.log(`${e}:`),console.error(...i);break;case c.Warn:console.warn(`${e}: `,...i);break;case c.Info:console.info(`${e}: `,...i);break;case c.Verbose:console.log(`${e}: `,...i)}}}class CoreConfigurations{}const u={app:"",defaults:{},mode:"standard",version:"1.70.0",build:{},logLevel:c.Error,locksMaxAge:864e5,serverCookies:!0,hashStoreStorageType:"persistent",dataLayerKey:"dataLayer",debug:[],debugClear:!1,transportTimeout:6e4,transportRetries:Number.POSITIVE_INFINITY,transportRetryBackoffMS:100,transportRetryBackoffMaxMS:3e4,serverBaseURL:"https://t.picsart.com/events/v1/web",pulseClientType:"browser",attributesStorageType:"persistent",tabManagerStorageType:"tab",sessionStorageType:"persistent",storagePrefix:"paa_",tabOpenerDetectionTimeWindow:6e3,initialDocURL:"",eventEnrichment:!0,handledErrorPrefix:"HANDLED ERROR >>>",rumUnsafeRequestBodyMeasure:!0,rumReportOnce:[],rumReport:[]};class AnalyticsEnvironment{constructor(e){this.win=e,this.doc=this.win.document,this.navigator=this.win.navigator,this.landingUrl=this.getInitialDocumentURL()}getInitialDocumentURL(){if("function"==typeof this.win.performance?.getEntries){const e=this.win.performance.getEntries().find((e=>"navigation"===e.entryType));if(e&&this.isValidURL(e.name))return e.name}return this.isValidURL(this.win.pulse?.idu)?this.win.pulse.idu:this.win.document.location.href}isValidURL(e){if("string"!=typeof e)return!1;try{return!!new URL(e).hostname}catch{return!1}}}class CryptoService{unsafeShortHash(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return t>>>=0,t.toString(36)}}class CookieParser{parseCookies(e){const t=[],i=e.split(";");for(const r of i){const e={},i=r.indexOf("=");i>-1?(e.name=r.slice(0,i).trim()||"",e.value=r.slice(i+1).trim()):(e.name="",e.value=r.trim()),e.name&&(e.name=(e.name||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),e.value=(e.value||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),t.push(e))}return t}serializeSetCookie(e){if(!e.name||"string"!=typeof e.name)throw new Error("Invalid cookie name!");const t={...e},i=encodeURIComponent(t.name).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),r=encodeURIComponent(t.value||"").replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent),n=this.serializeExpires(t.expires),s=[`${i}=${r}`];if("string"==typeof n&&s.push(`Expires=${n}`),"string"==typeof t.domain&&s.push(`Domain=${t.domain}`),s.push(`Path=${t.path||"/"}`),"string"==typeof e.sameSite){const i=e.sameSite.toUpperCase();"LAX"===i?s.push("SameSite=Lax"):"STRICT"===i?s.push("SameSite=Strict"):"NONE"===i&&(s.push("SameSite=None"),t.secure=!0)}return!0===t.secure&&s.push("Secure"),s.join("; ")}serializeExpires(e){if(Number.isSafeInteger(e)){const t=new Date(e);if(!isNaN(+t))return t.toUTCString()}}parseExpires(e){if("string"==typeof e){const t=Date.parse(e);if(Number.isSafeInteger(t))return t}}}var h=function(e,t){return h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},h(e,t)};function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function d(e,t,i,r){return new(i||(i=Promise))((function(n,s){function o(e){try{c(r.next(e))}catch(t){s(t)}}function a(e){try{c(r.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))}function p(e,t){var i,r,n,s,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(a){return function(c){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;s&&(s=0,a[0]&&(o=0)),o;)try{if(i=1,r&&(n=2&a[0]?r.return:a[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,a[1])).done)return n;switch(r=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return o.label++,{value:a[1],done:!1};case 5:o.label++,r=a[1],a=[0];continue;case 7:a=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){o=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){o.label=a[1];break}if(6===a[0]&&o.label<n[1]){o.label=n[1],n=a;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(a);break}n[2]&&o.ops.pop(),o.trys.pop();continue}a=t.call(e,o)}catch(c){a=[6,c],r=0}finally{i=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}Object.create;function g(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function f(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,s=i.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(r=s.next()).done;)o.push(r.value)}catch(a){n={error:a}}finally{try{r&&!r.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return o}function v(e,t,i){if(i||2===arguments.length)for(var r,n=0,s=t.length;n<s;n++)!r&&n in t||(r||(r=Array.prototype.slice.call(t,0,n)),r[n]=t[n]);return e.concat(r||Array.prototype.slice.call(t))}function m(e){return this instanceof m?(this.v=e,this):new m(e)}function y(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,n=i.apply(e,t||[]),s=[];return r={},o("next"),o("throw"),o("return"),r[Symbol.asyncIterator]=function(){return this},r;function o(e){n[e]&&(r[e]=function(t){return new Promise((function(i,r){s.push([e,t,i,r])>1||a(e,t)}))})}function a(e,t){try{(i=n[e](t)).value instanceof m?Promise.resolve(i.value.v).then(c,u):h(s[0][2],i)}catch(r){h(s[0][3],r)}var i}function c(e){a("next",e)}function u(e){a("throw",e)}function h(e,t){e(t),s.shift(),s.length&&a(s[0][0],s[0][1])}}function b(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=g(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(i){t[i]=e[i]&&function(t){return new Promise((function(r,n){(function(e,t,i,r){Promise.resolve(r).then((function(t){e({value:t,done:i})}),t)})(r,n,(t=e[i](t)).done,t.value)}))}}}Object.create;var S=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function w(e){return"function"==typeof e}function _(e){return w(null==e?void 0:e.then)}function E(e){var t=e((function(e){Error.call(e),e.stack=(new Error).stack}));return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var k=E((function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map((function(e,t){return t+1+") "+e.toString()})).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}}));function T(e,t){if(e){var i=e.indexOf(t);0<=i&&e.splice(i,1)}}var C=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var e,t,i,r,n;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var o=g(s),a=o.next();!a.done;a=o.next()){a.value.remove(this)}}catch(p){e={error:p}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else s.remove(this);var c=this.initialTeardown;if(w(c))try{c()}catch(m){n=m instanceof k?m.errors:[m]}var u=this._finalizers;if(u){this._finalizers=null;try{for(var h=g(u),l=h.next();!l.done;l=h.next()){var d=l.value;try{x(d)}catch(y){n=null!=n?n:[],y instanceof k?n=v(v([],f(n)),f(y.errors)):n.push(y)}}}catch(b){i={error:b}}finally{try{l&&!l.done&&(r=h.return)&&r.call(h)}finally{if(i)throw i.error}}}if(n)throw new k(n)}},e.prototype.add=function(t){var i;if(t&&t!==this)if(this.closed)x(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&T(t,e)},e.prototype.remove=function(t){var i=this._finalizers;i&&T(i,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),P=C.EMPTY;function I(e){return e instanceof C||e&&"closed"in e&&w(e.remove)&&w(e.add)&&w(e.unsubscribe)}function x(e){w(e)?e():e.unsubscribe()}var A={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},N={setTimeout:function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=N.delegate;return(null==n?void 0:n.setTimeout)?n.setTimeout.apply(n,v([e,t],f(i))):setTimeout.apply(void 0,v([e,t],f(i)))},clearTimeout:function(e){var t=N.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function O(e){N.setTimeout((function(){var t=A.onUnhandledError;if(!t)throw e;t(e)}))}function D(){}var L=R("C",void 0,void 0);function R(e,t,i){return{kind:e,value:t,error:i}}var M=null;function U(e){if(A.useDeprecatedSynchronousErrorHandling){var t=!M;if(t&&(M={errorThrown:!1,error:null}),e(),t){var i=M,r=i.errorThrown,n=i.error;if(M=null,r)throw n}}else e()}var B=function(e){function t(t){var i=e.call(this)||this;return i.isStopped=!1,t?(i.destination=t,I(t)&&t.add(i)):i.destination=K,i}return l(t,e),t.create=function(e,t,i){return new F(e,t,i)},t.prototype.next=function(e){this.isStopped?V(function(e){return R("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?V(R("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?V(L,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(C),q=Function.prototype.bind;function H(e,t){return q.call(e,t)}var j=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(i){z(i)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(i){z(i)}else z(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(t){z(t)}},e}(),F=function(e){function t(t,i,r){var n,s,o=e.call(this)||this;w(t)||!t?n={next:null!=t?t:void 0,error:null!=i?i:void 0,complete:null!=r?r:void 0}:o&&A.useDeprecatedNextContext?((s=Object.create(t)).unsubscribe=function(){return o.unsubscribe()},n={next:t.next&&H(t.next,s),error:t.error&&H(t.error,s),complete:t.complete&&H(t.complete,s)}):n=t;return o.destination=new j(n),o}return l(t,e),t}(B);function z(e){var t;A.useDeprecatedSynchronousErrorHandling?(t=e,A.useDeprecatedSynchronousErrorHandling&&M&&(M.errorThrown=!0,M.error=t)):O(e)}function V(e,t){var i=A.onStoppedNotification;i&&N.setTimeout((function(){return i(e,t)}))}var K={closed:!0,next:D,error:function(e){throw e},complete:D},$="function"==typeof Symbol&&Symbol.observable||"@@observable";function G(e){return e}function Q(e){return 0===e.length?G:1===e.length?e[0]:function(t){return e.reduce((function(e,t){return t(e)}),t)}}var Y=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var i=new e;return i.source=this,i.operator=t,i},e.prototype.subscribe=function(e,t,i){var r,n=this,s=(r=e)&&r instanceof B||function(e){return e&&w(e.next)&&w(e.error)&&w(e.complete)}(r)&&I(r)?e:new F(e,t,i);return U((function(){var e=n,t=e.operator,i=e.source;s.add(t?t.call(s,i):i?n._subscribe(s):n._trySubscribe(s))})),s},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var i=this;return new(t=J(t))((function(t,r){var n=new F({next:function(t){try{e(t)}catch(i){r(i),n.unsubscribe()}},error:r,complete:t});i.subscribe(n)}))},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[$]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Q(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=J(e))((function(e,i){var r;t.subscribe((function(e){return r=e}),(function(e){return i(e)}),(function(){return e(r)}))}))},e.create=function(t){return new e(t)},e}();function J(e){var t;return null!==(t=null!=e?e:A.Promise)&&void 0!==t?t:Promise}function W(e){return w(e[$])}function X(e){return Symbol.asyncIterator&&w(null==e?void 0:e[Symbol.asyncIterator])}function Z(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var ee="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function te(e){return w(null==e?void 0:e[ee])}function ie(e){return y(this,arguments,(function(){var t,i,r;return p(this,(function(n){switch(n.label){case 0:t=e.getReader(),n.label=1;case 1:n.trys.push([1,,9,10]),n.label=2;case 2:return[4,m(t.read())];case 3:return i=n.sent(),r=i.value,i.done?[4,m(void 0)]:[3,5];case 4:return[2,n.sent()];case 5:return[4,m(r)];case 6:return[4,n.sent()];case 7:return n.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}}))}))}function re(e){return w(null==e?void 0:e.getReader)}function ne(e){if(e instanceof Y)return e;if(null!=e){if(W(e))return n=e,new Y((function(e){var t=n[$]();if(w(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")}));if(S(e))return r=e,new Y((function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()}));if(_(e))return i=e,new Y((function(e){i.then((function(t){e.closed||(e.next(t),e.complete())}),(function(t){return e.error(t)})).then(null,O)}));if(X(e))return se(e);if(te(e))return t=e,new Y((function(e){var i,r;try{for(var n=g(t),s=n.next();!s.done;s=n.next()){var o=s.value;if(e.next(o),e.closed)return}}catch(a){i={error:a}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}e.complete()}));if(re(e))return se(ie(e))}var t,i,r,n;throw Z(e)}function se(e){return new Y((function(t){(function(e,t){var i,r,n,s;return d(this,void 0,void 0,(function(){var o,a;return p(this,(function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),i=b(e),c.label=1;case 1:return[4,i.next()];case 2:if((r=c.sent()).done)return[3,4];if(o=r.value,t.next(o),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),n={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),r&&!r.done&&(s=i.return)?[4,s.call(i)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(n)throw n.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}}))}))})(e,t).catch((function(e){return t.error(e)}))}))}function oe(e){return function(t){if(function(e){return w(null==e?void 0:e.lift)}(t))return t.lift((function(t){try{return e(t,this)}catch(i){this.error(i)}}));throw new TypeError("Unable to lift unknown Observable type")}}function ae(e,t,i,r,n){return new ce(e,t,i,r,n)}var ce=function(e){function t(t,i,r,n,s,o){var a=e.call(this,t)||this;return a.onFinalize=s,a.shouldUnsubscribe=o,a._next=i?function(e){try{i(e)}catch(r){t.error(r)}}:e.prototype._next,a._error=n?function(e){try{n(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,a._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,a}return l(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;e.prototype.unsubscribe.call(this),!i&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(B);function ue(e,t){return oe((function(i,r){var n=0;i.subscribe(ae(r,(function(i){r.next(e.call(t,i,n++))})))}))}function he(e,t,i,r,n){void 0===r&&(r=0),void 0===n&&(n=!1);var s=t.schedule((function(){i(),n?e.add(this.schedule(null,r)):this.unsubscribe()}),r);if(e.add(s),!n)return s}function le(e,t,i){return void 0===i&&(i=1/0),w(t)?le((function(i,r){return ue((function(e,n){return t(i,e,r,n)}))(ne(e(i,r)))}),i):("number"==typeof t&&(i=t),oe((function(t,r){return function(e,t,i,r,n,s,o,a){var c=[],u=0,h=0,l=!1,d=function(){!l||c.length||u||t.complete()},p=function(e){return u<r?g(e):c.push(e)},g=function(e){s&&t.next(e),u++;var a=!1;ne(i(e,h++)).subscribe(ae(t,(function(e){null==n||n(e),s?p(e):t.next(e)}),(function(){a=!0}),void 0,(function(){if(a)try{u--;for(var e=function(){var e=c.shift();o?he(t,o,(function(){return g(e)})):g(e)};c.length&&u<r;)e();d()}catch(i){t.error(i)}})))};return e.subscribe(ae(t,p,(function(){l=!0,d()}))),function(){null==a||a()}}(t,r,e,i)})))}var de=Array.isArray;function pe(e){return ue((function(t){return function(e,t){return de(t)?e.apply(void 0,v([],f(t))):e(t)}(e,t)}))}var ge=["addListener","removeListener"],fe=["addEventListener","removeEventListener"],ve=["on","off"];function me(e,t,i,r){if(w(i)&&(r=i,i=void 0),r)return me(e,t,i).pipe(pe(r));var n=f(function(e){return w(e.addEventListener)&&w(e.removeEventListener)}(e)?fe.map((function(r){return function(n){return e[r](t,n,i)}})):function(e){return w(e.addListener)&&w(e.removeListener)}(e)?ge.map(ye(e,t)):function(e){return w(e.on)&&w(e.off)}(e)?ve.map(ye(e,t)):[],2),s=n[0],o=n[1];if(!s&&S(e))return le((function(e){return me(e,t,i)}))(ne(e));if(!s)throw new TypeError("Invalid event target");return new Y((function(e){var t=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return e.next(1<t.length?t:t[0])};return s(t),function(){return o(t)}}))}function ye(e,t){return function(i){return function(r){return e[i](t,r)}}}function be(e,t){return oe((function(i,r){var n=0;i.subscribe(ae(r,(function(i){return e.call(t,i,n++)&&r.next(i)})))}))}var Se=E((function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}})),we=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return l(t,e),t.prototype.lift=function(e){var t=new _e(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new Se},t.prototype.next=function(e){var t=this;U((function(){var i,r;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var n=g(t.currentObservers),s=n.next();!s.done;s=n.next()){s.value.next(e)}}catch(o){i={error:o}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(i)throw i.error}}}}))},t.prototype.error=function(e){var t=this;U((function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var i=t.observers;i.length;)i.shift().error(e)}}))},t.prototype.complete=function(){var e=this;U((function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}}))},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,i=this,r=i.hasError,n=i.isStopped,s=i.observers;return r||n?P:(this.currentObservers=null,s.push(e),new C((function(){t.currentObservers=null,T(s,e)})))},t.prototype._checkFinalizedStatuses=function(e){var t=this,i=t.hasError,r=t.thrownError,n=t.isStopped;i?e.error(r):n&&e.complete()},t.prototype.asObservable=function(){var e=new Y;return e.source=this,e},t.create=function(e,t){return new _e(e,t)},t}(Y),_e=function(e){function t(t,i){var r=e.call(this)||this;return r.destination=t,r.source=i,r}return l(t,e),t.prototype.next=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===i||i.call(t,e)},t.prototype.error=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===i||i.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,i;return null!==(i=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==i?i:P},t}(we);class PulseStorage{constructor(e){this.options=e,this.changes=new we}change(e,t="full",i="external"){let r=this.changes.asObservable().pipe(be((e=>"all"===i||("external"===i?e.external:!e.external))));if(e)if(t&&"full"!==t){if("start"!==t)throw new Error("Invalid keyMatch value!");r=r.pipe(be((t=>t.key.startsWith(e))))}else r=r.pipe(be((t=>t.key===e)));return r}getJSON(e){const t=this.get(e);return"string"==typeof t?JSON.parse(t):null}setJSON(e,t){const i=JSON.stringify(t);this.set(e,i)}getStorageKey(e){const t=this.options.storagePrefix;return t?`${t}${e}`:e}revertStorageKey(e){const t=this.options.storagePrefix;return t?.length?e.slice(this.options.storagePrefix.length):e}isStorageKey(e){return!this.options.storagePrefix||e.startsWith(this.options.storagePrefix)}emitChange(e){this.changes.next(e)}}class PulseSyncStorage extends PulseStorage{constructor(e,t,i){super(i),this.storageArea=t,me(e.win,"storage").pipe(be((e=>!!e.key&&e.storageArea===t&&this.isStorageKey(e.key))),ue((e=>({key:this.revertStorageKey(e.key),value:e.newValue,external:!0})))).subscribe((e=>this.emitChange(e)))}get(e){return this.storageArea.getItem(this.getStorageKey(e))}set(e,t){try{this.storageArea.setItem(this.getStorageKey(e),t),this.emitChange({key:e,value:t,external:!1})}catch(i){console.error(i)}}keys(){return Object.keys(this.storageArea).filter((e=>this.isStorageKey(e))).map((e=>this.revertStorageKey(e)))}remove(e){this.storageArea.removeItem(this.getStorageKey(e)),this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Object.keys(this.storageArea).filter((e=>this.isStorageKey(e))).reduce(((e,t)=>{const i=this.revertStorageKey(t),r=this.storageArea.getItem(t);return"string"==typeof r&&(e[i]=r),e}),{})}}class PersistentStorage extends PulseSyncStorage{constructor(e,t){super(e,e.win.localStorage,t)}}var Ee,ke=function(e){function t(t){var i=e.call(this)||this;return i._value=t,i}return l(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var i=e.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},t.prototype.getValue=function(){var e=this,t=e.hasError,i=e.thrownError,r=e._value;if(t)throw i;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(we);class DebugService{constructor(e,t){this.storage=e,this.KEY_DEBUG="debug",e.change(this.KEY_DEBUG).subscribe((e=>this.getDebugKeys(e.value)));const i=this.getDebugKeys();this.items=new ke(i),Array.isArray(t.debug)&&this.enable(...t.debug),t.debugClear&&this.disableAll()}enabled(e){const t=this.getDebugKeys();return t.has(e)||t.has("all")}enable(...e){const t=this.getDebugKeys();let i=!1;for(const r of e)i=i||!t.has(r),t.add(r);i&&this.set(Array.from(t))}disable(...e){const t=this.getDebugKeys();let i=!1;for(const r of e)i=i||t.has(r),t.delete(r);i&&this.set(Array.from(t))}disableAll(){this.getDebugKeys().clear(),this.set([])}set(e){this.storage.set(this.KEY_DEBUG,JSON.stringify(e)),this.debugItems=new Set(e),this.items.next(this.debugItems)}getDebugKeys(e){if(!this.debugItems||e){let t;try{if(t=JSON.parse(e||this.storage.get(this.KEY_DEBUG)||""),!Array.isArray(t))throw new Error("Failed to parse debug mode!")}catch{t=[]}this.debugItems=new Set(t)}return this.debugItems}}!function(e){e["event_enrichment.tab_id"]="event_enrichment.tab_id",e["event_enrichment.url"]="event_enrichment.url",e["event_enrichment.previous_url"]="event_enrichment.previous_url",e["event_enrichment.referrer"]="event_enrichment.referrer",e["event_enrichment.legacy_source"]="event_enrichment.legacy_source",e["state_enrichment.device_id"]="state_enrichment.device_id",e["state_enrichment.session_id"]="state_enrichment.session_id",e["state_enrichment.app"]="state_enrichment.app",e["state_enrichment.market"]="state_enrichment.market",e["state_enrichment.platform"]="state_enrichment.platform",e["state_enrichment.version"]="state_enrichment.version",e["state_enrichment.language_code"]="state_enrichment.language_code",e["state_enrichment.pulse_version"]="state_enrichment.pulse_version"}(Ee||(Ee={}));class FeatureToggleService{constructor(){this.toggles=new Map}on(e,t=!0){return this.toggles.has(e)?this.toggles.get(e):t}set(e,t){this.toggles.set(e,t)}}class TransientStorage extends PulseStorage{constructor(){super({storagePrefix:""}),this.db=new Map}get(e){return this.db.get(e)??null}set(e,t,i=!1){this.db.set(e,t),this.emitChange({key:e,value:t,external:i})}keys(){return Array.from(this.db.keys())}remove(e){this.db.delete(e),this.emitChange({key:e,value:null,external:!1})}clear(){this.db=new Map}all(){return Array.from(this.db.entries()).reduce(((e,[t,i])=>(e[t]=i,e)),{})}}class DateService{constructor(e){this.env=e;const t=this.now(),i=this.hrt(),r=e.win.performance.timeOrigin;this.hrtTimeOrigin=r??t-i}now(){return this.env.win.Date.now()}hrtTime(){return this.hrtTimeOrigin+this.env.win.performance.now()}hrt(){return this.env.win.performance.now()}timezoneOffset(){const e=new this.env.win.Date;return e.getTimezoneOffset&&e.getTimezoneOffset()}}function Te(e){return new Promise((t=>{setTimeout(t,e)}))}class HttpService{constructor(e,t,i,r,n,s){this.documentVisibility=e,this.env=t,this.date=i,this.logger=r,this.config=n,this.deviceIdService=s,this.timeoutLimit=2e4}get async(){return this.documentVisibility.visible}async get(e,t,i){return this.retry((()=>this.trySendGetRequest(e,t,i)),this.config.transportRetries,this.config.transportTimeout)}async post(e,t,i,r=!1){return await this.retry((()=>this.trySendPostRequest(e,t,r,i)),this.config.transportRetries,this.config.transportTimeout)}async put(e,t,i){return(await this.env.win.fetch(e,{method:"PUT",headers:t,body:JSON.stringify(i)})).json()}async delete(e,t){return(await this.env.win.fetch(e,{method:"DELETE",headers:t})).json()}async retry(e,t=Number.MAX_SAFE_INTEGER,i=6e4){const r=this.date.now();let n=0;for(;;){const o=n<t;if(this.date.now()-r>i)throw new Error("Timedout!");if(!o)throw new Error("Max retries exeeded!");if(!(0===n||this.env.navigator.onLine)){const e=i-(this.date.now()-r);await this.waitForNetwork(e)}try{const t=await e();if(t)return t;throw new Error("Request Failed!")}catch(s){this.logger.error(s);const e=this.backoffTime(++n);await Te(e)}}}waitForNetwork(e){return new Promise(((t,i)=>{let r=!1,n=!1;if(this.env.win.navigator.onLine)return t();setTimeout((()=>{r||(n=!0,i(new Error("No internet connection!")))}),e),this.env.win.addEventListener("online",(()=>{n||(r=!0,t())}))}))}succeeded(e){return"boolean"==typeof e?e:e>=200&&e<=400}backoffTime(e){if(!this.async&&e<10)return 0;const t=Math.floor(Math.pow(1e3,e/50)*this.config.transportRetryBackoffMS);return Math.min(this.config.transportRetryBackoffMaxMS,t)}fetchPossible(){const e=this.env.win,t="Request"in e&&"boolean"==typeof new Request(this.config.serverBaseURL).keepalive;return!("function"!=typeof e.fetch||!("AbortController"in e)||!this.async&&!t)}sendBeacon(e,t){return this.env.win.navigator.sendBeacon(`${t}/beacon`,e)}async trySendGetRequest(e,t,i){let r;if(this.fetchPossible()){const n=new AbortController,s=setTimeout((()=>n.abort()),this.timeoutLimit),o={method:"GET",headers:t,credentials:"include",signal:n.signal};"high"===i&&(o.priority=i);const a=await this.env.win.fetch(e,o);if(clearTimeout(s),!a)return{ok:!1,body:void 0,headers:new Map,status:400};const c=await(a?.json()),u=new Map(a.headers.entries());r={ok:a.ok,body:c,headers:u,status:a?.status},"object"==typeof r&&r?.headers.has("paa-did")&&this.replaceDeviceId(r.headers.get("paa-did"))}else r=await this.sendGetXHR(e,t,!0);return r}async trySendPostRequest(e,t,i,r){let n;if(this.fetchPossible()){let s,o,a;try{if(s=await this.env.win.fetch(`${e}/fetch`,{method:"POST",headers:t,body:JSON.stringify(r),credentials:"include",keepalive:i}),o=new Map(s.headers.entries()),a=await s.json(),s.status>=500)return!1;n={ok:4===s.status,body:a.body,headers:o,status:s.status}}catch{return!1}"object"==typeof n&&n?.headers.has("paa-did")&&this.replaceDeviceId(n.headers.get("paa-did"))}else if(i&&"function"==typeof this.env.win.navigator?.sendBeacon){if(this.sendBeacon(JSON.stringify(r),e))return!0;n=await this.sendPostXHR(JSON.stringify(r),!0,t,e)}else n=await this.sendPostXHR(JSON.stringify(r),!0,t,e);return n}async sendGetXHR(e,t,i){const r=this.env,n=this.config,s=new Promise(((s,o)=>{try{const o=new r.win.XMLHttpRequest;i&&(o.timeout=n.transportTimeout,o.onreadystatechange=()=>{this.requestStateChange(o,s)}),o.open("GET",`${e}`,i),o.withCredentials=!0,o.timeout=this.timeoutLimit;for(const e in t)o.setRequestHeader(e,String(t[e]));o.send()}catch(a){o(a)}}));return await s}sendPostXHR(e,t,i,r){return new Promise(((n,s)=>{try{const s=new this.env.win.XMLHttpRequest;t&&(s.timeout=this.config.transportTimeout,s.onreadystatechange=()=>{this.requestStateChange(s,n)}),s.open("POST",`${r}/xhr`,t),s.withCredentials=!0;for(const e in i)s.setRequestHeader(e,String(i[e]));s.send(e),t||n(s.response)}catch(o){s(o)}}))}requestStateChange(e,t){if(4===e.readyState){const i=this.succeeded(e.status),r=new Map;let n;e.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(((e,t)=>{r.set(t.toString(),e)}));try{n=JSON.parse(e.response)}catch{throw new Error(`${e.response} is not a JSON!`)}const s={ok:i,status:e.status,body:n,headers:r};"object"==typeof s&&s?.headers.has("paa-did")&&this.replaceDeviceId(r.get("paa-did")),t(s)}}replaceDeviceId(e){e&&this.deviceIdService.setDeviceId(e)}}function Ce(e){return void 0===e&&(e=1/0),le(G,e)}var Pe=new Y((function(e){return e.complete()}));function Ie(e){return e&&w(e.schedule)}function xe(e){return e[e.length-1]}function Ae(e){return Ie(xe(e))?e.pop():void 0}function Ne(e,t){return void 0===t&&(t=0),oe((function(i,r){i.subscribe(ae(r,(function(i){return he(r,e,(function(){return r.next(i)}),t)}),(function(){return he(r,e,(function(){return r.complete()}),t)}),(function(i){return he(r,e,(function(){return r.error(i)}),t)})))}))}function Oe(e,t){return void 0===t&&(t=0),oe((function(i,r){r.add(e.schedule((function(){return i.subscribe(r)}),t))}))}function De(e,t){if(!e)throw new Error("Iterable cannot be null");return new Y((function(i){he(i,t,(function(){var r=e[Symbol.asyncIterator]();he(i,t,(function(){r.next().then((function(e){e.done?i.complete():i.next(e.value)}))}),0,!0)}))}))}function Le(e,t){if(null!=e){if(W(e))return function(e,t){return ne(e).pipe(Oe(t),Ne(t))}(e,t);if(S(e))return function(e,t){return new Y((function(i){var r=0;return t.schedule((function(){r===e.length?i.complete():(i.next(e[r++]),i.closed||this.schedule())}))}))}(e,t);if(_(e))return function(e,t){return ne(e).pipe(Oe(t),Ne(t))}(e,t);if(X(e))return De(e,t);if(te(e))return function(e,t){return new Y((function(i){var r;return he(i,t,(function(){r=e[ee](),he(i,t,(function(){var e,t,n;try{t=(e=r.next()).value,n=e.done}catch(s){return void i.error(s)}n?i.complete():i.next(t)}),0,!0)})),function(){return w(null==r?void 0:r.return)&&r.return()}}))}(e,t);if(re(e))return function(e,t){return De(ie(e),t)}(e,t)}throw Z(e)}function Re(e,t){return t?Le(e,t):ne(e)}function Me(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Ae(e),r=function(e,t){return"number"==typeof xe(e)?e.pop():t}(e,1/0),n=e;return n.length?1===n.length?ne(n[0]):Ce(r)(Re(n,i)):Pe}function Ue(e,t){return void 0===t&&(t=G),e=null!=e?e:Be,oe((function(i,r){var n,s=!0;i.subscribe(ae(r,(function(i){var o=t(i);!s&&e(n,o)||(s=!1,n=o,r.next(i))})))}))}function Be(e,t){return e===t}const qe={capture:!0,passive:!0};class DocumentVisibilityTracker{constructor(e){this.env=e,this.hiddenPropName="hidden",this.visibilityStatePropName="visibilityState",this.visibilityEventName="visibilitychange",this.configureVisibilityListener()}get visible(){return this.isPageVisible()}onVisibilityChange(){const e=this.env.win.document;let t=new we;return this.configureVisibilityListener()&&(t=me(e,this.visibilityEventName).pipe(ue((()=>this.isPageVisible())))),this.fullVisibilityAPISupport()||(t=Me(t,this.legacyVisibilityEvents())),t.pipe(Ue())}legacyOnUnload(){const e=this.env.win;return Me(this.legacyPageHide(),me(e,"beforeunload",qe),me(e,"unload",qe))}legacyPageHide(){return me(this.env.win,"pagehide",qe)}legacyVisibilityEvents(){return Me(this.legacyOnUnload().pipe(ue((()=>!1))),me(this.env.win,"pageshow",qe).pipe(ue((()=>!0))),me(this.env.win,"focus",qe).pipe(ue((()=>!0)))).pipe(Ue())}isPageVisible(){const e=this.env.doc;return"string"==typeof e[this.visibilityStatePropName]&&e[this.visibilityStatePropName]?"visible"===e[this.visibilityStatePropName]:"boolean"==typeof e[this.hiddenPropName]?!e[this.hiddenPropName]:!this.env.win.document.hasFocus||this.env.win.document.hasFocus()}configureVisibilityListener(){const e=["","ms","webkit","moz","o"],t=this.env.doc;for(const i of e){const e=i?`${i}Hidden`:"hidden",r=i?`${i}VisibilityState`:"visibilityState",n=(i||"")+"visibilitychange";if(e in t||r in t)return this.hiddenPropName=e,this.visibilityEventName=n,this.visibilityStatePropName=r,!0}return!1}fullVisibilityAPISupport(){const e=this.env.doc,t=this.env.win.navigator.userAgent;return"string"==typeof e.visibilityState&&"boolean"==typeof e.hidden&&void 0!==e.onvisibilitychange&&!/Safari/i.test(t)}}class DeviceIdService{constructor(e,t,i="external"){this.uuid=e,this.storage=t,this.storageChange=i,this.KEY_DEVICE_ID="did",this.registerStorageChangeListeners()}getDeviceId(){return this.deviceId?this.deviceId:this.fetchDeviceId()}setDeviceId(e){e!==this.deviceId&&"string"==typeof e&&e.trim()&&(this.deviceId=e.trim(),this.storage.set(this.KEY_DEVICE_ID,e))}generateDeviceId(){return this.uuid.generate()}registerStorageChangeListeners(){this.storage.change(this.KEY_DEVICE_ID,"full",this.storageChange).subscribe((e=>{this.setDeviceId(e.value||"")}))}fetchDeviceId(){return this.deviceId=this.storage.get(this.KEY_DEVICE_ID),this.deviceId||(this.deviceId=this.generateDeviceId(),this.storage.set(this.KEY_DEVICE_ID,this.deviceId)),this.deviceId}}var He=i(488),je=i.n(He);const Fe=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const ze=function(e){return"string"==typeof e&&Fe.test(e)},Ve=[];for(let i=0;i<256;++i)Ve.push((i+256).toString(16).slice(1));const Ke=function(e,t=0){const i=function(e,t=0){return(Ve[e[t+0]]+Ve[e[t+1]]+Ve[e[t+2]]+Ve[e[t+3]]+"-"+Ve[e[t+4]]+Ve[e[t+5]]+"-"+Ve[e[t+6]]+Ve[e[t+7]]+"-"+Ve[e[t+8]]+Ve[e[t+9]]+"-"+Ve[e[t+10]]+Ve[e[t+11]]+Ve[e[t+12]]+Ve[e[t+13]]+Ve[e[t+14]]+Ve[e[t+15]]).toLowerCase()}(e,t);if(!ze(i))throw TypeError("Stringified UUID is invalid");return i};class UUIDService{constructor(e,t){this.date=e,this.env=t,this.nativePRNG=this.getNativePRNG()}generate(){const e=this.date.now();return`a.${this.nativePRNG?"c":"m"}.${e.toString(36)}.${this.generateV4()}`}generateV4(){const e=this.randomValues(new Uint8Array(16));return e[6]=15&e[6]|64,e[8]=63&e[8]|128,Ke(e)}randomValues(e){if(this.nativePRNG)return this.nativePRNG(e);this.mersenne||(this.mersenne=new(je())(this.weakSeed()));let t=e.length;for(;t--;)e[t]=Math.floor(256*this.mersenne.random());return e}weakSeed(){const e=Array(127).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)));return[this.date.now(),...e]}getNativePRNG(){const e=this.env.win;return e.crypto?.getRandomValues?.bind(e.crypto)||e.msCrypto?.getRandomValues?.bind(e.msCrypto)||void 0}}class DeviceInfoService{constructor(e,t){this.env=e,this.date=t}getHardwareInfo(){const{navigator:e}=this.env.win,t=this.getGPU();return{device_memory:e.deviceMemory||void 0,hardware_concurrency:e.hardwareConcurrency||void 0,gpu_vendor:t?.vendor,gpu_renderer:t?.renderer}}getScreenInfo(){const e=this.env.win,t=e.screen;return{touch:e.navigator.maxTouchPoints>0||e.navigator.msMaxTouchPoints>0||"ontouchstart"in navigator,resolution_x:t.width,resolution_y:t.height,available_resolution_x:t.availWidth,available_resolution_y:t.availHeight,pixel_ratio:e.devicePixelRatio,pixel_depth:t.pixelDepth}}getNavigatorInfo(){const e=this.env.win.navigator;return{language:e.language,languages:e.languages,platform:e.platform,timezone_offset:this.date.timezoneOffset(),user_agent:e.userAgent,vendor:e.vendor}}getGPU(){const e=this.env.win.document.createElement("canvas");try{const t=e.getContext("webgl")||e.getContext("experimental-webgl"),i=t?.getExtension("WEBGL_debug_renderer_info");if(!i)return;const r=t.getParameter(i.UNMASKED_VENDOR_WEBGL),n=t.getParameter(i.UNMASKED_RENDERER_WEBGL);if(r||n)return{vendor:r,renderer:n}}catch{}}}class AnalyticsTransport{constructor(e,t,i){this.debug=e,this.config=t,this.httpService=i}send(e,t=!1,i=void 0,r){const n=`${this.config.serverBaseURL}/${this.config.app}`,s=this.getHeaders();this.httpService.post(n,s,{chunks:e.chunks},t).then((()=>{i?.({size:e.size||0,batchId:r})})).catch((e=>{console.error(`Batch didn't send ${e}`)}))}getHeaders(){const e=this.debug.enabled("receiver");return{"Content-Type":"application/json","receiver-debug":String(e)}}}class PageInfoService{constructor(e){this.env=e}host(){return this.env.win.location.host}landingPageUrl(){return this.env.landingUrl.toLowerCase()}referrer(){return this.env.doc.referrer}href(){return this.env.win.location.href}url(){return new URL(this.env.win.location.href)}}class PulseBroadcastChannel{constructor(e,t,i){this.persistentStorage=t,this.env=i,this.messages=new we,this.channelName=`pulse_bc_${e}`,this.init()}postMessage(e){this.nativeChannel?this.nativeChannel.postMessage(e):this.persistentStorage.setJSON(this.channelName,e)}init(){if(this.env.win.BroadcastChannel)return this.nativeChannel=new this.env.win.BroadcastChannel(this.channelName),void this.nativeChannel.addEventListener("message",(e=>{this.messages.next(e.data)}));this.persistentStorage.change(this.channelName,"full","external").subscribe((e=>{const t=JSON.parse(e.value||"null");this.messages.next(t)}))}}function $e(e){return"object"==typeof e&&e?Array.isArray(e)?e.map((e=>$e(e))):Object.keys(e).sort().reduce(((t,i)=>(t[i]=$e(e[i]),t)),{}):e}class HashStore{constructor(e,t,i){this.storage=e,this.crypto=t,this.date=i,this.KEY_ATTR_HASHES="hs",this.hashes=new Map,this.refresh(),this.storage.change(this.KEY_ATTR_HASHES).subscribe((e=>this.refresh(e.value)))}changed(e,t,i,r=!0){let n=t;"object"==typeof t&&t?n=JSON.stringify($e(t)):"string"!=typeof t&&(n=JSON.stringify(t),void 0===n&&(n="undefined"));const s=this.date.now(),o=this.crypto.unsafeShortHash(e),a=this.crypto.unsafeShortHash(n),c=this.hashes.get(o),[u,h]=(c||"").split("."),l=parseInt(h||"0",36);return!(u===a&&(!i||l&&!(s-l>i)))&&(this.hashes.set(o,`${a}.${s.toString(36)}`),this.persist(),!(!r&&!c))}refresh(e){let t=e?JSON.parse(e):this.storage.getJSON(this.KEY_ATTR_HASHES);t&&Array.isArray(t.hs)||(t={hs:[]},this.storage.setJSON(this.KEY_ATTR_HASHES,t)),this.hashes=new Map(t.hs)}persist(){const e={hs:Array.from(this.hashes)};this.storage.setJSON(this.KEY_ATTR_HASHES,e)}}function Ge(e,t,i=!0){return"boolean"==typeof e?e:e&&"boolean"==typeof e[t]?e[t]??i:i}class TabStorage extends PulseSyncStorage{constructor(e,t){super(e,e.win.sessionStorage,t)}}class TabManagerService{constructor(e,t,i,r){this.tabStorage=e,this.lockManager=t,this.uuid=i,this.tabIdKey="tab_id",this.enabled=!0,this.config={storagePrefix:"paa_"},this.enabled=Ge(r.eventEnrichment,"tab_id")}async init(){this.enabled&&(this.tabId=await this.trackTabId())}getSiblingTabId(e){try{return new TabStorage(e,this.config).get(this.tabIdKey)}catch{return console.error("Sibling tab referance is invalid"),null}}getTabId(){if(!this.tabId)throw new Error("TabManager is not initialized!");return this.tabId}async trackTabId(){const e=this.tabStorage.get(this.tabIdKey);let t=await this.lockAndUseTabId(e);if(!t){const e=this.uuid.generate();return t=await this.lockAndUseTabId(e),t||console.warn("Failed to lock the tab identifier!"),e}return t}async lockAndUseTabId(e){if(!e)return null;const t=`${this.tabIdKey}_${e}`;return await this.lockManager.request(t)?(this.tabStorage.set(this.tabIdKey,e),e):(this.tabStorage.clear(),null)}}class LockManager{}class TabInfoService{constructor(e,t,i,r,n,s){this.persistentStorage=e,this.visibilityService=t,this.activityTracker=i,this.activitySynchronizer=r,this.date=n,this.config=s,this.unloaded=!1,this.persisted=!1;const o=n.now();this.lastActivity=o}startService(e){this.tabId=e,this.setupActivityTracker(),this.updateTabInfo(),this.cleanup()}fetchSiblingTabs(e=""){if(!Ge(this.config.eventEnrichment,"tab_id"))return[];if(!this.tabId)throw new Error("Tab identifier is not available!");const t=this.tabId;return this.persistentStorage.keys().filter((i=>i.startsWith(`tab_info_${e}`)&&-1===i.indexOf(t))).map((e=>this.persistentStorage.getJSON(e))).filter(Boolean)}getCurrentTab(){if(!this.tabId)throw new Error("Tab identifier is not available!");return{id:this.tabId,lastActivity:this.lastActivity,persisted:this.persisted,unloaded:this.unloaded,visible:this.visibilityService.visible}}updateTabInfo(){const e=this.getCurrentTab();this.persistentStorage.setJSON(`tab_info_${e.id}`,e)}cleanup(){const e=this.date.now(),t=this.fetchSiblingTabs().filter((t=>e-t.lastActivity>this.config.tabOpenerDetectionTimeWindow));for(const i of t)this.persistentStorage.remove(`tab_info_${i.id}`),this.activitySynchronizer.remove(i.id)}setupActivityTracker(){this.visibilityService.legacyPageHide().subscribe((e=>{this.unloaded=!0,this.persisted=e.persisted,this.updateTabInfo()})),this.visibilityService.legacyOnUnload().subscribe((()=>{this.unloaded=!0,this.updateTabInfo()})),this.activityTracker.interactions().subscribe((()=>{this.lastActivity=this.date.now(),this.updateTabInfo()}))}}var Qe={now:function(){return(Qe.delegate||Date).now()},delegate:void 0},Ye=function(e){function t(t,i,r){void 0===t&&(t=1/0),void 0===i&&(i=1/0),void 0===r&&(r=Qe);var n=e.call(this)||this;return n._bufferSize=t,n._windowTime=i,n._timestampProvider=r,n._buffer=[],n._infiniteTimeWindow=!0,n._infiniteTimeWindow=i===1/0,n._bufferSize=Math.max(1,t),n._windowTime=Math.max(1,i),n}return l(t,e),t.prototype.next=function(t){var i=this,r=i.isStopped,n=i._buffer,s=i._infiniteTimeWindow,o=i._timestampProvider,a=i._windowTime;r||(n.push(t),!s&&n.push(o.now()+a)),this._trimBuffer(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),i=this._infiniteTimeWindow,r=this._buffer.slice(),n=0;n<r.length&&!e.closed;n+=i?1:2)e.next(r[n]);return this._checkFinalizedStatuses(e),t},t.prototype._trimBuffer=function(){var e=this,t=e._bufferSize,i=e._timestampProvider,r=e._buffer,n=e._infiniteTimeWindow,s=(n?1:2)*t;if(t<1/0&&s<r.length&&r.splice(0,r.length-s),!n){for(var o=i.now(),a=0,c=1;c<r.length&&r[c]<=o;c+=2)a=c;a&&r.splice(0,a+1)}},t}(we);function Je(e,t,i){var r=w(e)||t||i?{next:e,error:t,complete:i}:e;return r?oe((function(e,t){var i;null===(i=r.subscribe)||void 0===i||i.call(r);var n=!0;e.subscribe(ae(t,(function(e){var i;null===(i=r.next)||void 0===i||i.call(r,e),t.next(e)}),(function(){var e;n=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()}),(function(e){var i;n=!1,null===(i=r.error)||void 0===i||i.call(r,e),t.error(e)}),(function(){var e,t;n&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)})))})):G}const We=e=>{let t="other";return"A"===e.nodeName?t="link":"BUTTON"===e.nodeName||e instanceof HTMLInputElement&&"button"===e.type?t="button":e instanceof HTMLInputElement&&("submit"===e.type?t="submit":"reset"===e.type?t="reset":"file"===e.type?t="file":"submit"!==e.type&&"reset"!==e.type&&"file"!==e.type&&(t="input")),t},Xe=(e,t)=>t?.hasAttribute(e)||t?.hasAttribute(`data-${e}`),Ze=e=>e instanceof HTMLAnchorElement||e instanceof HTMLButtonElement?e.innerText:e instanceof HTMLInputElement&&("button"===e.type||"submit"===e.type||"reset"===e.type)?e.value:e===document.body?"<body>":e===document.documentElement?"<document>":e===document.head?"<head>":e.labels?.length?Array.from(e.labels||[]).map((e=>e.innerText)).join(" "):null,et=e=>{const t=We(e),i=Array.from(e.classList),r=(e=>{const t=["class","value","id","name"];return Array.from(e.attributes).map((e=>({name:e.name,value:e.value}))).filter((e=>-1===t.indexOf(e.name)))})(e),n=e.getAttribute("pulse-name")||e.getAttribute("data-pulse-name")||e.getAttribute("pulse-clickable")||e.getAttribute("data-pulse-clickable")||e.name||e.getAttribute("name")||void 0;return{attributes:r,attributeValueByName:r.reduce(((e,t)=>({...e,[t.name]:t.value})),{}),classList:i,nodeType:t,id:e.id,name:n,nodeName:e.nodeName,text:Ze(e)||void 0}},tt=(e,t)=>{const i=e?e.getAttribute("pulse-section")||e.getAttribute("data-pulse-section"):null,r=t?t.getAttribute("pulse-section-group")||t.getAttribute("data-pulse-section-group"):null;return{name:i||r||void 0,group:r||i||void 0,sectionElement:e&&et(e),sectionGroupElement:t&&et(t)}},it=["click","contextmenu"],rt=[...it];class ActivityTracker{constructor(e,t,i,r){this.visibilityTracker=e,this.win=t,this.tabManagerService=i,this.config=r,this.registerListeners()}interactions(){return this.interactionEventsSubject}mutations(){return this.mutationEventsSubject}registerListeners(){if(!this.interactionEventsSubject){const e=this.interactionEvents(),t=this.mutationEvents(),i=new Ye,r=new Ye;e.subscribe(i),t.subscribe(r),this.interactionEventsSubject=i,this.mutationEventsSubject=r}}mutationEvents(){const e=new Ye;return new MutationObserver((t=>{const i=t.flatMap((e=>[...Array.from(e.addedNodes)])).filter((e=>e instanceof HTMLElement)).flatMap((e=>{const t=this.getInteractionInfoFor(e);if(!t||!Xe("pulse-component",t.element))return[];const i=et(t.element),r=i.attributeValueByName["pulse-component"]||i.attributeValueByName["data-pulse-component"],n=i.attributeValueByName["pulse-component-type"]||i.attributeValueByName["data-pulse-component-type"];return this.isHidden(t.element)?[]:{element:i,component:r,componentType:n||r,section:tt(t.section,t.sectionGroup)}}));i.length&&e.next({addedElements:i})})).observe(document,{childList:!0,subtree:!0}),e}isHidden(e){const t=this.win.win.getComputedStyle(e);return"none"===t.display||"hidden"===t.visibility||void 0===t.display}interactionEvents(){const e=this.win.doc.body,t={capture:!0,passive:!0};return Re(rt).pipe(ue((i=>me(e,i,t))),Ce(),ue((e=>this.processWindowEvent(e))),be(Boolean),Je((e=>{"click"!==e.type&&"contextmenu"!==e.type||e.doNotTrack||!e.clickable||(this.lastClickSourceInformation={name:e.section.name,group:e.section.group,element:e.element,url:e.docURL,tab_id:Ge(this.config.eventEnrichment,"tab_id")?this.tabManagerService.getTabId():""})})))}processWindowEvent(e){if(!e.target)return null;const t=this.getInteractionInfoFor(e.target);if(!t)return null;const i=window.document;return{type:e.type,trusted:e.isTrusted??!0,eventPhase:e.eventPhase,bubbles:e.bubbles,section:tt(t.section,t.sectionGroup),element:et(t.element),docFocused:i.hasFocus(),docVisible:this.visibilityTracker.visible,docURL:i.location.href,doNotTrack:t.doNotTrack,clickable:t.clickable,ts:Date.now()}}getInteractionInfoFor(e){const t=this.win.doc,i=e instanceof Node&&e!==t&&e!==t.head?e:t.documentElement;let r=(e=>{let t=e;for(;t;){if(t instanceof HTMLElement)return t;t=t.parentElement}return null})(i);if(!r)return;const n=We(i),s=r.closest("[pulse-section]")||r.closest("[data-pulse-section]")||void 0,o=r.closest("[pulse-section-group]")||r.closest("[data-pulse-section-group]")||void 0,a=(e=>{let t=e,i=!1;for(;t&&!i;){const e=We(t);i=Boolean("submit"===e||"button"===e||"link"===e||Xe("pulse-clickable",t)),i||(t=t.parentElement)}return t})(r);r=a||r;const c=Boolean(r.closest("[pulse-dnt]"));return{clickable:Boolean(a),doNotTrack:Boolean(c),type:n,element:r,section:s,sectionGroup:o}}}class ActivitySynchronizer{constructor(e,t,i,r){this.persistentStorage=e,this.activityTracker=t,this.date=i,this.config=r,this.pageEvents=[]}startService(e){this.activityTracker.interactions().subscribe((t=>{const i=this.date.now();this.pageEvents.push(t),this.pageEvents=this.pageEvents.slice(this.pageEvents.length-100).filter((e=>i-e.ts<=this.config.tabOpenerDetectionTimeWindow)),this.pageEvents.length?this.persistentStorage.setJSON(`tab_activity_${e}`,this.pageEvents):this.remove(e)})),this.clearClosedTabsActivity()}getTabEvents(e){return this.persistentStorage.getJSON(`tab_activity_${e}`)}remove(e){this.persistentStorage.remove(`tab_activity_${e}`)}clearClosedTabsActivity(){const e=this.fetchOpenTabIds();this.persistentStorage.keys().filter((e=>e.startsWith("tab_activity_"))).filter((t=>{const i=this.getTabEvents(t.replace("tab_activity_",""))?.map((e=>e.ts)).reduce(((e,t)=>Math.max(e,t)));return!(i&&i>this.config.tabOpenerDetectionTimeWindow+5e3)&&-1===e.indexOf(t.replace("tab_activity_",""))})).map((e=>this.persistentStorage.remove(e)))}fetchOpenTabIds(){return this.persistentStorage.keys().filter((e=>e.startsWith("tab_info_"))).map((e=>e.replace("tab_info_","")))}}var nt;!function(e){e[e.LinkInteraction=1]="LinkInteraction",e[e.Link=2]="Link",e[e.Interaction=3]="Interaction",e[e.Focus=4]="Focus",e[e.Visibility=5]="Visibility",e[e.NoVisibility=6]="NoVisibility"}(nt||(nt={}));class TabOpenerDetector{constructor(e,t,i,r,n,s,o){this.tabInfoService=e,this.tabStorage=t,this.activitySyncService=i,this.tabManager=r,this.date=n,this.env=s,this.config=o,this.opener=null,this.firstNavigationKey="first_navigation",this.firstNavigation=!0}getOpener(e=!1){const t=this.opener||this.fetchOpener(),i=this.tabStorage.getJSON(this.firstNavigationKey),r=void 0===i?.firstNavigation;this.firstNavigation=r,this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:i?.lastNavigationCount||0,lastNavigationUrl:e&&r?this.env.win.location.href:i?.lastNavigationUrl||""});const n="number"!=typeof this.env.win.history?.length||1===this.env.win.history.length,s=this.env.win.history.length>1&&r,o=s?5e3:0,a=n?this.config.tabOpenerDetectionTimeWindow:Math.max(o,Math.min(1e3,this.config.tabOpenerDetectionTimeWindow/2)),c=n?nt.NoVisibility:nt.Focus;if(t?.id)return t;let u,h=null;this.env.win.opener&&(h=this.tabManager.getSiblingTabId({win:this.env.win.opener})),u=h?this.tabInfoService.fetchSiblingTabs(h):this.tabInfoService.fetchSiblingTabs();const l=u.map((e=>{const t=this.activitySyncService.getTabEvents(e.id)||[];return{tabId:e.id,events:t}})),d=this.detectOpener(this.env.win.document.referrer,l,a,c,s);this.setOpener({id:d?.tabId||h,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element});return d?.tabId?{id:d?.tabId,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element}:null}isFirstNavigation(){return this.firstNavigation}getTriggerEvent(e=!1){if(!Ge(this.config.eventEnrichment,"tab_id"))return null;const t=this.tabStorage.getJSON(this.firstNavigationKey),i=void 0===t?.firstNavigation,r=t?.lastNavigationCount||0;this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:this.env.win.history.length,lastNavigationUrl:this.env.win.location.href}),this.firstNavigation=i;const n=this.env.win.history.length-r>1&&!i,s=n?5e3:e?3500:500,o=nt.NoVisibility,a=t?.lastNavigationUrl||this.env.win.document.referrer,c=this.tabInfoService.getCurrentTab(),u=this.activitySyncService.getTabEvents(c.id)||[],h=this.detectTriggerEvent(a,u,s,o,n,c.id);return h?{id:h?.tabId,type:h?.type,url:h?.eventUrl,name:h?.section.name,group:h?.section.group,element:h?.element}:null}fetchOpener(){return this.opener=this.tabStorage.getJSON("tab_opener"),this.opener}detectOpener(e,t,i,r,n){const s=this.createDetectorEvents(e,t).filter((e=>e.timeDiff<=i));if(!s.length)return null;for(let o=1;o<=r;o++){const t=this.filterAccuracyMatches(s,e,o,n);if(t.length&&(o<nt.NoVisibility||1===this.countTabs(t)))return t[0]||null}return null}detectTriggerEvent(e,t,i,r,n,s){const o=this.ctreateTriggerEvents(e,t,s).filter((e=>e.timeDiff<=i));if(!o.length)return null;for(let a=1;a<=r;a++){const t=this.filterAccuracyMatches(o,e,a,n);if(t.length&&a<nt.NoVisibility)return t[0]||null}return null}setOpener(e){return this.opener=e,this.tabStorage.setJSON("tab_opener",this.opener)}filterAccuracyMatches(e,t,i,r){switch(i){case nt.LinkInteraction:return this.filterLinkInteractionEvents(e,t);case nt.Link:return this.filterLinkEvents(e,t);case nt.Interaction:return this.filterInteractionEvents(e,t);case nt.Focus:return this.filterFocusedEvents(e,t,r);case nt.Visibility:return this.filterVisibleEvents(e,t);case nt.NoVisibility:default:return this.filterNoVisibility(e,t)}}filterLinkInteractionEvents(e,t){return e.filter((e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible))}filterLinkEvents(e,t){return e.filter((e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&e.docFocused&&e.docVisible))}filterInteractionEvents(e,t){return e.filter((e=>(!t||e.docURL.startsWith(t))&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible))}filterFocusedEvents(e,t,i){return e.filter((e=>i?e.docFocused&&e.docVisible:(!t||e.docURL.startsWith(t))&&e.docFocused&&e.docVisible))}filterVisibleEvents(e,t){return e.filter((e=>(!t||e.docURL.startsWith(t))&&e.docVisible))}filterNoVisibility(e,t){return e.filter((e=>!t||e.docURL.startsWith(t)))}isLinkMatch(e){if(e.element&&"A"===e.element.nodeName){const t=e.element.attributes.find((e=>"href"===e.name))?.value;return t===this.config.initialDocURL}return!1}isInteractionEvent(e){return-1!==it.indexOf(e.type)}countTabs(e){return new Set(e.map((e=>e.tabId))).size}createDetectorEvents(e,t){const i=this.date.hrtTimeOrigin-2,r=[];for(const n of t){const t=n.events.map((t=>({...t,tabId:n.tabId,timeDiff:Math.abs(i-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL})));r.push(...t)}return r.sort(((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0))}ctreateTriggerEvents(e,t,i){const r=this.date.now()-2;let n=[];return n=t.map((t=>({...t,tabId:i,timeDiff:Math.abs(r-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL}))),n.sort(((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0))}}class CookieChangeDetector{constructor(e,t){this.env=t;const i=this.patchChanges();i.pipe(be((e=>!e))).subscribe((()=>{e.postMessage(!0)})),e.messages.pipe(ue((()=>!0))).subscribe(i)}changes(){return this.patchChanges()}patchChanges(){const e=this.env.doc;let t=CookieChangeDetector.patchedDocuments.get(e);if(t)return t;t=new we,CookieChangeDetector.patchedDocuments.set(e,t);const i=this.env.win.Document.prototype,r=Object.getOwnPropertyDescriptor(i,"cookie");let n=e.cookie;const s={enumerable:!0,configurable:!0,get:()=>e.__native_cookie,set:i=>{e.__native_cookie=i;const r=e.__native_cookie;if(r!==n)try{t.next(!1)}finally{n=r}}};return Object.defineProperty(i,"__native_cookie",r),Object.defineProperty(i,"cookie",s),t}}CookieChangeDetector.patchedDocuments=new Map;class CookieStorage extends PulseStorage{constructor(e,t,i,r){super(r),this.env=e,this.parser=t,this.changeDetector=i,this.cookies=new Map,this.pull(!1),this.changeDetector.changes().pipe(be((e=>e||!r.storagePrefix))).subscribe((()=>this.pull()))}get(e){return this.cookies.get(e)??null}set(e,t){const i={name:this.getStorageKey(e),value:t};this.cookies.set(e,t);const r=this.parser.serializeSetCookie(i);this.env.doc.cookie=r,this.emitChange({key:e,value:t,external:!1})}keys(){return Array.from(this.cookies.keys())}remove(e){const t={name:this.getStorageKey(e),value:"",expires:0};this.cookies.delete(e);const i=this.parser.serializeSetCookie(t);this.env.doc.cookie=i,this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Array.from(this.cookies).reduce(((e,[t,i])=>("string"==typeof i&&(e[t]=i),e)),{})}pull(e=!0){const t=this.cookies,i=this.fetchCookies(),r=new Set([...t.keys(),...i.keys()]);if(this.cookies=i,e)for(const n of r){const e=t.get(n),r=i.get(n)??null;if(e!==r){const e={key:n,value:r,external:!0};this.emitChange(e)}}}fetchCookies(){const e=this.env.doc,t=this.parser.parseCookies(e.cookie).filter((e=>this.isStorageKey(e.name)));for(const r of t)r.name=this.revertStorageKey(r.name);const i=t.map((e=>[e.name,e.value]));return new Map(i)}}class Quote{async quoteSize(){return new Promise((e=>{try{navigator.storage.estimate?navigator.storage.estimate().then((t=>{e(t.quota)})).catch((t=>{console.error(t),e(null)})):e(null)}catch(t){console.error(t),e(null)}}))}}var st=E((function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}}));function ot(e){return oe((function(t,i){var r,n=null,s=!1;n=t.subscribe(ae(i,void 0,void 0,(function(o){r=ne(e(o,ot(e)(t))),n?(n.unsubscribe(),n=null,r.subscribe(i)):s=!0}))),s&&(n.unsubscribe(),n=null,r.subscribe(i))}))}class IndexedDBService{constructor(e){this.env=e,this.connectionState$=new ke("NOT_CONNECTED"),this.storeList=["settingsStore","attributesStore"],this.pulseDB="pulseDB",this.env.win.indexedDB.deleteDatabase("settingsDB")}get db(){if(!this._db)throw Error("IndexDB store not exist ");return this._db}async truncate(e){const t=await this.getTransaction(e,"readwrite");return new Promise(((i,r)=>{try{const n=t.objectStore(e).clear();n.onerror=e=>{this.logerr(e),r(e)},n.onsuccess=()=>{i(n.result)}}catch(n){r(n)}}))}async getValue(e,t){const i=await this.getTransaction(e,"readonly");return new Promise(((r,n)=>{try{const n=i.objectStore(e).get(t);n.onerror=this.logerr,n.onsuccess=()=>{r(n.result)}}catch(s){n(s)}}))}async getAllValue(e){const t=await this.getTransaction(e,"readonly");return new Promise(((i,r)=>{try{const r=t.objectStore(e).getAll();r.onerror=this.logerr,r.onsuccess=()=>{i(r.result)}}catch(n){r(n)}}))}async putValue(e,t){const i=await this.getTransaction(e,"readwrite");return new Promise(((r,n)=>{try{const n=i.objectStore(e).put(t);n.onsuccess=()=>{r(!0)},n.onerror=this.logerr}catch(s){n(s)}}))}async putBulkValue(e,t){const i=(await this.getTransaction(e,"readwrite")).objectStore(e);for(const r of t)await i.put(r);return await this.getAllValue(e)}async deleteValue(e,t){const i=await this.getTransaction(e,"readwrite");return new Promise(((r,n)=>{try{const n=i.objectStore(e),s=n.get(t);s.onsuccess=()=>{s.result||r("-1"),n.delete(t).onsuccess=()=>r(t)},s.onerror=this.logerr}catch(s){n(s)}}))}async connectDB(){this.connectionState$.next("CONNECTING");const e=this.env.win.indexedDB.open(this.pulseDB,1);return new Promise(((t,i)=>{try{e.onerror=e=>{this.connectionState$.next("NOT_CONNECTED"),this.logerr(e)},e.onsuccess=()=>{this.createObjectStore(e.result),t(e.result)},e.onupgradeneeded=e=>{e.target&&e.target?.result&&this.createObjectStore(e.target?.result)}}catch(r){this.connectionState$.next("NOT_CONNECTED"),i(r)}}))}logerr(e){console.log(e)}createObjectStore(e,t=!1){this.storeList.forEach((t=>{if(!e.objectStoreNames.contains(t)){const i=e.createObjectStore(t,{autoIncrement:!1,keyPath:"id"});i.createIndex("id","id",{unique:!0}),i.createIndex("time","time",{unique:!1}),i.createIndex("id_time",["id","time"],{unique:!0})}})),this._db=e,this.connectionState$.next("CONNECTED"),this.db.onclose=this.reconnectDB.bind(this),this.db.onabort=this.reconnectDB.bind(this)}getTransaction(e,t,i){if("CONNECTED"===this.connectionState$.getValue())try{return Promise.resolve(this.db.transaction(e,t,i))}catch(r){this.connectDB()}return function(e,t){var i="object"==typeof t;return new Promise((function(r,n){var s=new F({next:function(e){r(e),s.unsubscribe()},error:n,complete:function(){i?r(t.defaultValue):n(new st)}});e.subscribe(s)}))}(this.connectionState$.pipe(be((e=>"CONNECTED"===e)),ue((()=>this.db.transaction(e,t,i))),ot((e=>{return this.logerr(e),r=w(t=e)?t:function(){return t},n=function(e){return e.error(r())},new Y(i?function(e){return i.schedule(n,0,e)}:n);var t,i,r,n}))))}reconnectDB(e){e&&this.logerr(`${u.handledErrorPrefix} ${JSON.stringify(e)}`),this.connectDB()}}class NativeLockManager{constructor(e,t){this.env=e,this.uuid=t,this.locks=new Map,this.lockManager=e.win.navigator.locks}async supported(){let e=!1;try{this.lockManager?.query&&(await(this.lockManager?.query()),e=!0)}catch{e=!1}return"function"==typeof this.lockManager?.request&&"function"==typeof this.lockManager?.query&&"function"==typeof this.env.win.AbortController&&e}async locked(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");return(await this.lockManager.query()).held.some((t=>t.name===e))}request(e,t=1e3){if(!this.lockManager)throw new Error("Native LockManager not supported!");const i=new AsyncTask,r=new AsyncTask,n=new AbortController,s={signal:n.signal};let o=!1;return this.lockManager.request(e,s,(()=>{o=!0;const t={name:e,id:this.uuid.generate(),clientId:"",createdDate:0,task:r};return this.locks.set(e,t),i.resolve(t),r.waitUntilResolved()})).catch((()=>i.resolve(null))),Te(t).then((()=>{o||(n.abort(),i.resolve(null))})).catch((e=>{console.error(e)})),i.waitUntilResolved()}async release(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");const t=this.locks.get(e.name);t&&t.id===e.id&&(t.task.resolve(),this.locks.delete(t.name))}}class UnsafeLockManager{constructor(e,t,i,r,n){this.storage=e,this.date=t,this.config=i,this.uuid=r,this.id=r.generate(),this.locks=this.syncLocks(),this.storage.change("locks","full","external").subscribe((e=>{this.syncLocks(e.value)})),n.legacyOnUnload().subscribe((()=>this.releaseAll()))}async release(e,t=!0){const i=this.locks.get(e.name);i&&i.clientId===this.id&&i.id===e.id&&(this.locks.delete(i.name),t&&this.syncLocks())}async locked(e){return this.locks.has(e)}async request(e,t=100,i=10){const r=this.date.now();for(;;){const n=await this.lock(e),s=this.date.now()-r>t;if(n||s)return n;await Te(i)}}async lock(e){if(this.locks.has(e))return null;{const t={name:e,clientId:this.id,id:this.uuid.generate(),createdDate:this.date.now()};return this.locks.set(e,t),this.syncLocks(),t}}syncLocks(e){if(!this.locks||e){const t=e||this.storage.get("locks"),i=JSON.parse(t||"null"),r=new Map(i||[]),n=this.releaseExpiredLocks(r);this.locks=n,r.size!==n.size&&this.writeLocks(n)}else this.writeLocks(this.locks);return this.locks}writeLocks(e){0===e.size?this.storage.remove("locks"):this.storage.setJSON("locks",Array.from(e))}releaseAll(){for(const[e,t]of this.locks)t.clientId===this.id&&this.release(t,!1);this.syncLocks()}releaseExpiredLocks(e){const t=this.date.now(),i=Array.from(e).filter((([e,i])=>t-i.createdDate<this.config.locksMaxAge));return new Map(i)}}class ExperimentDebugService{constructor(e,t,i,r){this.storage=e,this.page=t,this.env=i,this.config=r,this.experiment=null,this.control=null;const n=new URL(this.page.landingPageUrl()).searchParams.get("pulse-debug-exp")||this.storage.get("debug-exp"),s=this.parseExperimentInfo(n);this.cleanupURL(),n&&s&&(this.storage.set("debug-exp",n),this.experiment=s,this.displayControls(s))}getDebugExperiment(){return this.experiment}cleanupURL(){const e=this.page.url();e.searchParams.has("pulse-debug-exp")&&(e.searchParams.delete("pulse-debug-exp"),this.env.win.history.replaceState(this.env.win.history.state,this.env.doc.title,e.href))}stopDebugging(){this.experiment=null,this.storage.remove("debug-exp"),this.control&&this.animateOut(this.control)}parseExperimentInfo(e){if("string"!=typeof e||!e.length)return null;try{const[t,i,r,n,s]=JSON.parse(e);return t!==this.config.app?null:{app:t,id:i,name:r,variant:n,url:s}}catch(t){return console.error("Failed to parse debug experiment info!"),console.error(t),null}}async displayControls({id:e,name:t,variant:i,url:r}){this.control=this.createElements(`${i} ${t}`,`Debugging Experiment [${e}]: ${t}\n\nVariant: ${i}`,r),this.control.button.addEventListener("click",(()=>{console.log("exiting experiment debug mode..."),this.stopDebugging()})),this.addStyles(),this.animateIn(this.control)}async animateIn(e){window.document.body.appendChild(e.fragment),await Te(10),e.container.classList.add("active"),await Te(500),e.container.classList.add("animate"),await Te(1500),e.container.classList.remove("animate")}async animateOut(e){e.container.classList.remove("active"),await Te(1e3),this.env.win.location.reload()}createElements(e,t,i){const r=window.document,n=`<svg class="pulse-exp-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 72 72"><path fill="currentColor" d="M67.625 56.738c-.033-.05.035.049 0 0L47.823 28.167V5.42c0-1.105-.539-1.92-1.643-1.92H27.179c-1.104 0-1.356.816-1.356 1.92v22.097L4.904 56.764c-.035.049-.217.277-.248.33-1.688 2.926-2.078 5.621-.785 7.86 1.306 2.261 3.915 3.546 7.347 3.546h49.451c3.429 0 6.118-1.287 7.424-3.551 1.296-2.245 1.22-5.283-.468-8.211zM29.137 29.302c.237-.338.687-.74.687-1.152V7.5h14v21.301c0 .412-.194.824.044 1.161l9.19 13.262c-3.056 1.232-6.822 2.05-14.531-2.557-5.585-3.337-12.499-2.048-17.199-.449l7.809-10.916zM64.55 62.949c-.554.96-1.969 1.551-3.88 1.551H11.219c-1.915 0-3.33-.589-3.883-1.547-.532-.922-.324-2.391.571-3.975l11.287-15.777c3.942-1.702 12.219-4.454 18.308-.816 4.852 2.898 8.367 3.814 11.116 3.814 2.291 0 4.05-.637 5.607-1.291l9.755 14.076c.897 1.584 1.105 3.039.57 3.965z" /><path fill="currentColor" d="M22.026 50.969a5.476 5.476 0 00-5.471 5.471 5.477 5.477 0 005.471 5.471 5.477 5.477 0 005.471-5.471 5.476 5.476 0 00-5.471-5.471zm0 8.942c-1.914 0-3.471-1.558-3.471-3.472s1.557-3.471 3.471-3.471 3.471 1.557 3.471 3.471-1.557 3.472-3.471 3.472zM50.775 52.469a4.726 4.726 0 00-4.721 4.721 4.727 4.727 0 004.721 4.721 4.727 4.727 0 004.722-4.721 4.726 4.726 0 00-4.722-4.721zm0 7.442c-1.5 0-2.721-1.222-2.721-2.722s1.221-2.721 2.721-2.721 2.722 1.221 2.722 2.721-1.222 2.722-2.722 2.722zM35.077 45.469a4.025 4.025 0 00-4.021 4.021 4.025 4.025 0 004.021 4.021c2.217 0 4.021-1.805 4.021-4.021s-1.804-4.021-4.021-4.021zm0 6.043a2.024 2.024 0 01-2.021-2.021c0-1.114.907-2.021 2.021-2.021 1.114 0 2.021.906 2.021 2.021s-.907 2.021-2.021 2.021zM40.824 22.42a1 1 0 001-1v-11a1 1 0 10-2 0v11a1 1 0 001 1zM40.824 27.42a1 1 0 001-1v-1a1 1 0 10-2 0v1a1 1 0 001 1z" /></svg><div class="pulse-exp-details"><div class="pulse-exp-title"><a href="${i}" title="${t}" target="_blank">${e}</a></div><div><button>Exit preview</button></div></div>`,s=r.createElement("div");s.classList.add("pulse-exp-badge"),s.innerHTML=n;const o=r.createDocumentFragment();o.appendChild(s);const a=o.querySelector(".pulse-exp-details button");return{container:s,fragment:o,button:a}}addStyles(){const e=document.head||document.getElementsByTagName("head")[0],t=document.createElement("style");t.appendChild(document.createTextNode('.pulse-exp-badge{display:flex;position:fixed;z-index:9999999999;box-sizing:border-box;align-items:center;width:170px;height:40px;bottom:48vh;right:0;border:solid 1px #ff6d91;border-right:none;border-radius:1000px;border-top-right-radius:0;border-bottom-right-radius:0;box-shadow:0 2px 25px rgba(255,0,130,.1);color:#fff;text-align:center;font-family:sans-serif;font-size:10px;background-color:#1b1b1b;-webkit-user-select:none;-ms-user-select:none;user-select:none;transition:transform .2s;transform:translateX(200px);}.pulse-exp-badge.active{transition-delay:.5s;transform:translateX(135px);}.pulse-exp-badge.active:hover{transform:translateX(0);}.pulse-exp-badge .pulse-exp-details{width:10px;flex-grow:1111;}.pulse-exp-badge .pulse-exp-icon{padding:3px 10px;padding-right:5px;color:#ff6d91;}.pulse-exp-badge .pulse-exp-title{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;padding:0;margin:0;margin-bottom:3px;display:block;}.pulse-exp-badge .pulse-exp-title a{color:#fff;text-decoration:none;padding:0;margin:0;}.pulse-exp-badge .pulse-exp-title a:hover{text-decoration:underline;}.pulse-exp-badge button{padding:1px 5px;border:solid 1px #ff6d91;border-radius:3px;cursor:pointer;background:none;color:#ff6d91;font-size:10px;transition:all .15s;}.pulse-exp-badge button:hover{color:#fff;background-color:#bb1367;border:solid 1px #bb1367;}.pulse-exp-badge:before,.pulse-exp-badge:after{position:absolute;content:"";display:block;width:140%;height:100%;left:-20%;z-index:-1000;transition:all ease-in-out .5s;background-repeat:no-repeat;}.pulse-exp-badge:before{display:none;top:-75%;background-image:radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,transparent 20%,#ff0081 20%,transparent 30%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,transparent 10%,#ff0081 15%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%);background-size:10% 10%,20% 20%,15% 15%,20% 20%,18% 18%,10% 10%,15% 15%,10% 10%,18% 18%;}.pulse-exp-badge:after{display:none;bottom:-75%;background-image:radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,transparent 10%,#ff0081 15%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%),radial-gradient(circle,#ff0081 20%,transparent 20%);background-size:15% 15%,20% 20%,18% 18%,20% 20%,15% 15%,10% 10%,20% 20%;}.pulse-exp-badge.animate:before{display:block;animation:topBubbles ease-in-out .75s forwards;}.pulse-exp-badge.animate:after{display:block;animation:bottomBubbles ease-in-out .75s forwards;}@keyframes topBubbles{0%{background-position:5% 90%,10% 90%,10% 90%,15% 90%,25% 90%,25% 90%,40% 90%,55% 90%,70% 90%}50%{background-position:0 80%,0% 20%,10% 40%,20% 0%,30% 30%,22% 50%,50% 50%,65% 20%,90% 30%}100%{background-position:0 70%,0% 10%,10% 30%,20% -10%,30% 20%,22% 40%,50% 40%,65% 10%,90% 20%;background-size:0 0%,0% 0%,0% 0%,0% 0%,0% 0%,0% 0%}}@keyframes bottomBubbles{0%{background-position:10% -10%,30% 10%,55% -10%,70% -10%,85% -10%,70% -10%,70% 0%}50%{background-position:0 80%,20% 80%,45% 60%,60% 100%,75% 70%,95% 60%,105% 0%}100%{background-position:0 90%,20% 90%,45% 70%,60% 110%,75% 80%,95% 70%,110% 10%;background-size:0 0%,0% 0%,0% 0%,0% 0%,0% 0%,0% 0%}}')),e.appendChild(t)}}class Step{constructor(e,t=!1){this.value=e,this.optimized=t}toString(){return this.value}}class DOMPath{xPath(e,t){if(e.nodeType===Node.DOCUMENT_NODE)return"/";const i=[];let r=e;for(;r;){const e=this.xPathValue(r,t);if(!e)break;if(i.push(e),e.optimized)break;r=r.parentNode}return i.reverse(),(i.length&&i[0]?.optimized?"":"/")+i.join("/")}xPathValue(e,t){const i=this.xPathIndex(e);let r;if(-1===i)return null;switch(e.nodeType){case Node.ELEMENT_NODE:{const i=e;if(t&&i.getAttribute("id"))return new Step('//*[@id="'+i.getAttribute("id")+'"]',!0);r=i.localName;break}case Node.ATTRIBUTE_NODE:r="@"+e.nodeName;break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:r="text()";break;case Node.PROCESSING_INSTRUCTION_NODE:r="processing-instruction()";break;case Node.COMMENT_NODE:r="comment()";break;case Node.DOCUMENT_NODE:default:r=""}return i>0&&(r+="["+i+"]"),new Step(r,e.nodeType===Node.DOCUMENT_NODE)}xPathIndex(e){const t=e.parentNode?e.parentNode.children:null;if(!t)return 0;let i=!1;for(const n of t)if(this.areNodesSimilar(e,n)&&n!==e){i=!0;break}if(!i)return 0;let r=1;for(const n of t)if(this.areNodesSimilar(e,n)){if(n===e)return r;++r}return-1}areNodesSimilar(e,t){if(e===t)return!0;if(e.nodeType===Node.ELEMENT_NODE&&t.nodeType===Node.ELEMENT_NODE)return e.localName===t.localName;if(e.nodeType===t.nodeType)return!0;return(e.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:e.nodeType)===(t.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:t.nodeType)}}class EventAdapterService{constructor(e){this.env=e}push(e){this.env.win?.pulse?.q&&this.env.win.pulse.q.push(e)}}class DataLayerService{constructor(e){this.env=e}pushData(e){this.env.win.dataLayer||(this.env.win.dataLayer=[]),this.env.win.dataLayer.push(e)}}class LocationHistoryTracker{constructor(e,t,i){this.env=e,this.tabStorage=t,this.dateService=i,this.navigation=new we,this.lastLocationKey="last_location",this.internalLoadLimit=2e3;const r=this.getLastLocation();this.previousUrl=r?.locationURL||e.doc.referrer||"",this.popStatePreviousUrl=this.env.win.location.href,this.setLastLocation(this.env.win.location.href),addEventListener("beforeunload",(()=>{this.setLastLocation()}),{capture:!0}),this.init()}init(){"function"==typeof this.env.win.history?.pushState&&(this.patch("back"),this.patch("forward"),this.patch("go"),this.patch("pushState"),this.patch("replaceState"),this.env.win.addEventListener("popstate",(()=>{const e=this.env.win.location.href;this.popStatePreviousUrl!==e&&(this.previousUrl=this.popStatePreviousUrl,this.popStatePreviousUrl=e,this.setLastLocation(e),this.navigation.next(e))}),!1))}patch(e){const t=this.env.win.history,i=t[e].bind(t);t[e]=(...e)=>{const r=this.env.win.location.href;i.apply(t,e);const n=this.env.win.location.href;r!==n&&(this.setLastLocation(n),this.popStatePreviousUrl=n,this.previousUrl=r,this.navigation.next(n))}}setLastLocation(e=this.popStatePreviousUrl){this.tabStorage.setJSON(this.lastLocationKey,{locationURL:e,timestamp:this.dateService.now()})}getLastLocation(){let e=this.tabStorage.getJSON(this.lastLocationKey);return e=e?.timestamp&&this.dateService.hrtTimeOrigin-e?.timestamp<this.internalLoadLimit?this.env.win.location.href===e?.locationURL?null:e:null,e}}function at(e,t){return oe((function(i,r){var n=null,s=0,o=!1,a=function(){return o&&!n&&r.complete()};i.subscribe(ae(r,(function(i){null==n||n.unsubscribe();var o=0,c=s++;ne(e(i,c)).subscribe(n=ae(r,(function(e){return r.next(t?t(i,e,c,o++):e)}),(function(){n=null,a()})))}),(function(){o=!0,a()})))}))}function ct(){return new st}function ut(e,t){var i=arguments.length>=2;return function(r){return r.pipe(e?be((function(t,i){return e(t,i,r)})):G,(s=1)<=0?function(){return Pe}:oe((function(e,t){var i=0;e.subscribe(ae(t,(function(e){++i<=s&&(t.next(e),s<=i&&t.complete())})))})),i?function(e){return oe((function(t,i){var r=!1;t.subscribe(ae(i,(function(e){r=!0,i.next(e)}),(function(){r||i.next(e),i.complete()})))}))}(t):(void 0===(n=function(){return new st})&&(n=ct),oe((function(e,t){var i=!1;e.subscribe(ae(t,(function(e){i=!0,t.next(e)}),(function(){return i?t.complete():t.error(n())})))}))));var n,s}}function ht(e,t){const i="string"==typeof t?t:t?.entryType,r=e.entry_type===i,n=function(e,t){if("string"==typeof t)return!0;if(void 0===t.name)return!0;if(Array.isArray(t.name))return t.name.some((t=>t instanceof RegExp?t.test(e):t===e));return!1}(e.name,t),s="object"!=typeof t||"function"!=typeof t.filter||t.filter(e);return r&&n&&s}class RUMService{constructor(e,t){this.timeline=e,this.resource=t}subscribe(e,t){const i=[...e,...t||[]],r=i.some((e=>"resource"===e||"object"==typeof e&&"resource"===e.entryType)),n=Me(r?this.resource.subscribe(i):Re([]),this.timeline.subscribe(i).pipe(be((e=>"resource"!==e.entry_type)))),s=n.pipe(be((e=>!t||t.every((t=>!ht(e,t))))));return Me(Re(t||[]).pipe(at((e=>n.pipe(be((t=>ht(t,e))),ut())))),s).pipe(ue((e=>this.enrichWithServerAttributes(e))))}enrichWithServerAttributes(e){if(Array.isArray(e.server_timing)){const t=[...e.server_timing],i={};for(const r of e.server_timing){const e=/^pulse\$([^$]+)\$([^$]+)$/.exec(r.name);if(!e?.length)continue;const n=(e[1]||"").toLowerCase(),s=(e[2]||"").toLowerCase();i[n]=s,t.splice(t.indexOf(r),1)}e.server_timing=t,e.server_attributes=i}return e}}class PerformanceTimelineService{constructor(e,t,i,r){this.env=e,this.cssPathService=t,this.date=i,r.visible||(this.firstPageHide=i.hrtTimeOrigin),r.onVisibilityChange().pipe(be((e=>!e)),ut()).subscribe((()=>{this.firstPageHide=i.hrt()}))}subscribe(e,t=!0){return Me(...e.filter((e=>this.entrySupported(e))).map((e=>this.getFilterStream(e,t))))}getEntries(e){return Me(...e.filter((e=>this.entrySupported(e))).map((e=>this.getFilterStream(e,!1,!0))))}getFilterStream(e,t,i){const r=this.env.win;return r.performance.getEntries&&r.performance.getEntriesByType&&r.performance.timeOrigin?i?this.readEntries(e):"function"==typeof r.PerformanceObserver&&r.WeakSet?this.getFilterStreamNative(e,t):this.getFilterStreamLegacy(e,t):Re([])}readEntries(e){const t="string"==typeof e?e:e.entryType,i=new WeakSet;return Re(this.env.win.performance.getEntriesByType(t)).pipe(be((e=>!i.has(e))),Je((e=>i.add(e))),ue((e=>this.mapEntry(e))),be((t=>ht(t,e))))}getFilterStreamNative(e,t){return new Y((i=>{const r=new WeakSet,n=new this.env.win.PerformanceObserver((t=>{const n=t.getEntries();for(const s of n){if(r.has(s))continue;r.add(s);const t=this.mapEntry(s);ht(t,e)&&i.next(t)}})),s="string"==typeof e?e:e?.entryType;return n.observe({type:s,buffered:t}),()=>n.disconnect()}))}getFilterStreamLegacy(e,t){return new Y((i=>{const r=this.env.win.performance,n="string"==typeof e?e:e?.entryType;let s=t?0:r.now();const o=setInterval((()=>{const t=this.env.win.performance.getEntriesByType(n);let r=s;for(const n of t){const t=this.mapEntry(n);r<n.startTime&&(r=n.startTime),n.startTime<s||ht(t,e)&&i.next(t)}s=r}),1e3);return()=>clearInterval(o)}))}mapEntry(e){const t=this.env.win.navigator.connection,i="xmlhttprequest"===(e.initiatorType+"").toLowerCase()?"xhr":e.initiatorType;let r={time_origin:this.date.hrtTimeOrigin,details:e.detail,name:e.name,entry_type:e.entryType,type:e.type,protocol:e.nextHopProtocol||void 0,task_duration:e.duration,start_time:e.startTime,end_time:e.responseEnd??(e.duration?e.startTime+e.duration:void 0),initiator_type:i,worker_start:e.workerStart,redirect_start:e.redirectStart,redirect_end:e.redirectEnd,fetch_start:e.fetchStart,domain_lookup_start:e.domainLookupStart,domain_lookup_end:e.domainLookupEnd,connect_start:e.connectStart,connect_end:e.connectEnd,secure_connection_start:e.secureConnectionStart,request_start:e.requestStart,response_start:e.responseStart,response_end:e.responseEnd,transfer_size:e.transferSize,encoded_body_size:e.encodedBodySize,decoded_body_size:e.decodedBodySize,unload_event_start:e.unloadEventStart,unload_event_end:e.unloadEventEnd,dom_interactive:e.domInteractive,dom_content_loaded_event_start:e.domContentLoadedEventStart,dom_content_loaded_event_end:e.domContentLoadedEventEnd,dom_complete:e.domComplete,load_event_start:e.loadEventStart,load_event_end:e.loadEventEnd,redirect_count:e.redirectCount,processing_start:e.processingStart,processing_end:e.processingEnd,cancelable:e.cancelable,render_blocking:e.renderBlockingStatus?"blocking"===e.renderBlockingStatus:void 0,had_recent_input:e.hadRecentInput,last_input_time:e.lastInputTime,cls_value:e.value,before_page_hide:this.beforePageHide(e.startTime)};return Array.isArray(e.serverTiming)&&e.serverTiming.length&&(r.server_timing=e.serverTiming),Array.isArray(e.workerTiming)&&e.workerTiming.length&&(r.worker_timing=e.workerTiming),!t||"resource"!==r.entry_type&&"navigation"!==r.entry_type||(r={...r,connection_downlink:t.downlink,connection_rtt:t.rtt,connection_type:t.effectiveType,data_saving_mode:t.saveData}),Array.isArray(e.attribution)&&(r.attribution=e.attribution.map((e=>({name:e?.name,entry_type:e?.entryType,start_time:e?.startTime,duration:e?.duration,container_type:e?.containerType,container_src:e?.containerSrc,container_id:e?.containerId,container_name:e?.containerName})))),"layout-shift"===r.entry_type&&Array.isArray(e.sources)&&(r.cls_sources=e.sources.map((e=>this.createCLSAttribution(e))).filter(Boolean)),r}beforePageHide(e){return!this.firstPageHide||(e?e<this.firstPageHide:void 0)}entrySupported(e){const t=this.env.win.PerformanceObserver?.supportedEntryTypes||[],i="string"==typeof e?e:e.entryType;return t.indexOf(i)>-1}createCLSAttribution(e){if("object"!=typeof e||"object"!=typeof e.node)return null;const t=e.node,i={current_rect:e.currentRect,previous_rect:e.previousRect};if(t){const e=this.cssPathService.cssPath(t);i.node={path:e}}return i}}class RequestMonitorService{constructor(e,t,i,r,n){this.fetchCollector=e,this.xhrCollector=t,this.timeline=i,this.date=r,this.env=n;const s=new Ye(1e3);this.performanceTimeline=s,this.timeline.subscribe(["resource"]).subscribe(s)}subscribe(e){const t=this.date.hrt(),i=Me(this.fetchCollector.requests(),this.xhrCollector.requests()).pipe(at((e=>this.findEntry(e))));return Me(this.performanceTimeline.pipe(be((e=>"fetch"!==e.initiator_type&&"xhr"!==e.initiator_type||e.start_time<=t)),ue((e=>({entry:e})))),i).pipe(ue((e=>this.mergeRequestEntry(e))),be(Boolean),be((t=>!e||e.some((e=>ht(t,e))))))}mergeRequestEntry(e){const t=e.request,i=!!t&&("basic"===t.responseMode||"cors"===t.responseMode||"default"===t.responseMode);let r=e.entry;if(r)r.response_entry_matched=!!t;else{if(!t)return null;const e=this.env.win.navigator.connection;r={name:t.url,entry_type:"resource",initiator_type:t.initiator,start_time:t.start,end_time:t.end,task_duration:(t.fetchEnd||t.end)-t.start,time_origin:this.date.hrtTimeOrigin,response_entry_matched:!1},i&&(r.decoded_body_size=t.responseBodySize,r.transfer_size=t.responseBodySize),e&&(r={...r,connection_downlink:e.downlink,connection_rtt:e.rtt,connection_type:e.effectiveType,data_saving_mode:e.saveData})}return t&&this.enrichWithRequest(r,t,i),r}enrichWithRequest(e,t,i){e.request_method=t.method,e.response_status=t.responseStatus,e.response_mode=t.responseMode,e.request_body_size=t.requestBodySize,e.response_end=e.response_end||t.fetchEnd||t.end,e.end_time=t.end,e.user_duration=t.end-t.start,e.response_content_type=t.responseContentType,e.request_content_type=t.requestContentType,e.redirected=t.redirected,e.aborted=t.aborted,i&&(e.transfer_size=e.transfer_size||t.responseBodySize,e.response_body_size=t.responseBodySize,e.decoded_body_size=t.responseBodySize,e.transfer_size=t.responseBodySize)}findEntry(e){return this.performanceTimeline.pipe(be((e=>"fetch"===e.initiator_type||"xhr"===e.initiator_type)),be((t=>this.matchLax(e,t))),ut(),ue((t=>({entry:t,request:e}))))}matchLax(e,t){const i=t.start_time,r=t.task_duration?t.start_time+t.task_duration:t.response_end||0;return i>=e.start-1&&r<=e.end+1&&e.url===t.name}}const lt=new Set(["plain/text","text/html","text/css","text/xml","text/csv","text/javascript","application/json","application/ld+json","application/xml","application/xhtml+xml","application/atom+xml","application/javascript","application/x-javascript","image/svg+xml"]),dt=new Set(["font/woff2","font/ttf","image/gif","image/png","image/jpg","image/jpeg","image/webp","image/bmp"]),pt=new Set([...lt.values(),...dt.values()]);function gt(e,t){try{return new URL("string"==typeof e?e:e.href,t.win.location.href).href}catch(i){return"string"==typeof e?e:"object"==typeof e&&e.href?e.href:void 0}}function ft(e){if(e)return e.toLowerCase().split(";").map((e=>e.trim()))[0]}function vt(e,t){try{if(null==e||""===e)return 0;if("string"==typeof e)return new t.Blob([e]).size;if(e instanceof t.Blob)return e.size;if((e instanceof t.ArrayBuffer||t.ArrayBuffer.isView(e))&&"number"==typeof e.byteLength)return e.byteLength;if(e instanceof t.URLSearchParams)return vt(e.toString(),t);if("object"==typeof e)return vt(JSON.stringify(e),t)}catch{}}function mt(e,t,i,r){if(t?.body&&!function(e,t){return"ReadableStream"in t&&e instanceof t.ReadableStream}(t.body,r.win)){const i=new AsyncTask;try{const e=vt(t.body,r.win);i.resolve({size:e,start:-1,end:-1,cancelled:!1})}catch(n){i.reject(n)}return{wrappedRequest:new Request(e,t),bodyStats:i.waitUntilResolved()}}if("object"==typeof e&&e.body instanceof ReadableStream){const{wrappedStream:s,complete:o}=function(e,t,i){const r=new AsyncTask,s=new AsyncTask(3e5);let o=-1;const a=new i.ReadableStream({start(r){o=t.hrt();const a=e.getReader();let c=0;a.read().then((({done:e,value:a})=>{if(e){const e=t.hrt();return s.resolve({start:o,end:e,size:c,cancelled:!1}),void r.close()}try{c+=vt(a,i)??0}catch(n){console.error(n)}r.enqueue(a)})).catch((e=>{s.reject(e),r.error(e)}))},cancel(i){e.cancel(i);const r=t.hrt();s.resolve({start:o,end:r,cancelled:!0})}});return{started:r.waitUntilResolved(),complete:s.waitUntilResolved(),wrappedStream:a}}(e.body,i,r.win),a={cache:e?.cache,credentials:e?.credentials,headers:e?.headers,integrity:e?.integrity,keepalive:e?.keepalive,method:e?.method,mode:e?.mode,redirect:e?.redirect,referrer:e?.referrer,referrerPolicy:e?.referrerPolicy,signal:e?.signal,...t||{},body:s};return{wrappedRequest:new Request(e,a),bodyStats:o}}return{wrappedRequest:new Request(e,t),bodyStats:Promise.resolve(void 0)}}class FetchCollectorService{constructor(e,t){this.date=e,this.env=t,this.reportStream=new we,this.patched=!1}requests(){return this.patchFetch(),this.reportStream.asObservable()}supported(){return"ReadableStream"in this.env.win&&"ArrayBuffer"in this.env.win&&"Request"in this.env.win&&"Response"in this.env.win&&"function"==typeof this.env.win.fetch}patchFetch(){if(this.patched||!this.supported())return;const e=this.env.win,t=e.fetch.bind(e);this.env.win.fetch=async(e,i)=>this.monitoredFetch(e,i,t),this.patched=!0}async monitoredFetch(e,t,i){const r={url:"",method:"",start:0,fetchEnd:0,end:0,responseStatus:0,initiator:"fetch"};let n,s,o;try{n=mt(e,t,this.date,this.env),r.url=gt(n.wrappedRequest.url,this.env)||"",r.method=n.wrappedRequest.method.toUpperCase(),n.bodyStats.then((e=>{r.requestBodySize=e?.size})).catch((e=>{console.error(e)})),n.wrappedRequest.signal?.addEventListener("abort",(()=>{r.aborted=!0})),r.start=this.date.hrt(),s=await i(n.wrappedRequest),r.fetchEnd=this.date.hrt();try{r.responseBodySize=s.headers.has("content-length")?+s.headers.get("content-length"):void 0;("basic"===s.type||"cors"===s.type||"default"===s.type)&&r.responseContentType&&!Number.isSafeInteger(r.responseBodySize)&&pt.has(r.responseContentType)&&(o=s.clone())}catch{}return s}finally{r.fetchEnd=s?r.fetchEnd:this.date.hrt(),Te(0).then((()=>this.reportResponse(s,o,r))).catch((e=>console.error(e)))}}async reportResponse(e,t,i){if(i){if(e)try{const r=e.headers?.get("content-type");if(i.responseContentType=ft(r),i.redirected=e.redirected,i.responseMode=e.type,i.responseStatus=e.status,!Number.isSafeInteger(i.responseBodySize)&&t)try{const e=await t.blob();i.responseBodySize=e.size}catch{}}catch{}i.end=this.date.hrt(),this.reportStream.next(i)}}}function yt(e,t){if(!t||!e)return!1;if(lt.has(t))return!0;if(dt.has(t))try{return e instanceof Blob||e instanceof ArrayBuffer}catch(i){console.error(i)}return!1}function bt(e,t){const i=new we;function r(r){if(r.___pulse)return r.___pulse;const n={requestHeaders:new Headers,hasError:!1};return r.___pulse=n,r.addEventListener("error",(()=>{n.hasError=!0})),r.addEventListener("timeout",(()=>{n.hasError=!0,n.aborted=!0})),r.addEventListener("loadend",(s=>{n.end=e.hrt(),Te(0).then((()=>function(r,n,s){const o=ft(n.requestHeaders.get("content-type"));let a,c,u;yt(n.requestBody,o)&&(a=vt(n.requestBody,t.win));let h={url:n.url,method:n.method,start:n.start,fetchEnd:n.end,end:n.end,aborted:!!n.aborted,requestBodySize:a,requestContentType:o,responseStatus:r.status,initiator:"xhr"};if(n.hasError)i.next(h);else{try{u=ft(r.getResponseHeader("content-type"))}catch(l){console.error(l)}if(s.lengthComputable&&"number"==typeof s.total)c=s.total;else try{const e=+r.getResponseHeader("content-length");Number.isSafeInteger(e)&&(h.responseBodySize=e)}catch(l){console.error(l)}"number"!=typeof h.responseBodySize&&yt(r.response,u)&&(c=vt(r.response,t.win)),h={...h,responseBodySize:c,responseContentType:u,end:e.hrt()},i.next(h)}}(r,n,s))).catch((e=>console.error(e)))})),n}function n(e,t){const i=XMLHttpRequest.prototype[e];"function"==typeof i&&(XMLHttpRequest.prototype[e]=function(...e){const n=this,s=r(n);return t(n,s,i.bind(n),...e)})}return n("setRequestHeader",((e,t,i,...r)=>{const[n,s]=r;try{t.requestHeaders.set(n,s)}catch(o){console.error(o)}i.apply(e,r)})),n("open",((e,i,r,...n)=>{const[s,o]=n;r.apply(e,n),i.method=s,i.url=gt(o,t)||""})),n("send",((t,i,r,...n)=>{i.requestBody,i.start=e.hrt(),r.apply(t,n)})),n("abort",((e,t,i)=>{t.aborted=!0,i.apply(e)})),i.asObservable()}class XHRCollectorService{constructor(e,t){this.date=e,this.env=t}requests(){return this.stream||(this.stream=bt(this.date,this.env)),this.stream}}class CSSPathStep{constructor(e,t){this.value=e,this.optimized=t}toString(){return this.value}}class CSSPathService{cssPath(e,t=!1){try{if(e.nodeType!==Node.ELEMENT_NODE)return"";const i=[];let r=e;for(;r;){const n=this.createStep(r,!!t,r===e);if(!n)break;if(i.push(n),n?.optimized)break;r=r.parentNode}return i.reverse(),i.join(" > ")}catch(i){return console.error(i),""}}createStep(e,t,i){if(e.nodeType!==Node.ELEMENT_NODE)return null;const r=e.getAttribute("id");if(t){if(r)return new CSSPathStep(this.idSelector(r),!0);const t=e.nodeName.toLowerCase();if("body"===t||"head"===t||"html"===t)return new CSSPathStep(e.nodeName.toLowerCase(),!0)}const n=e.nodeName.toLowerCase();if(r)return new CSSPathStep(n.toLowerCase()+this.idSelector(r),!0);const s=e.parentNode;if(!s||s.nodeType===Node.DOCUMENT_NODE)return new CSSPathStep(n.toLowerCase(),!0);const o=this.prefixedElementClassNames(e),a=s.children;let c=!1,u=!1,h=-1;for(let d=0;(-1===h||!u)&&d<a.length;++d){const t=a[d];if(t===e){h=d;continue}if(u)continue;if(t?.nodeName.toLowerCase()!==n.toLowerCase())continue;c=!0;const i=o;let r=0;for(const e in i)++r;if(0===r){u=!0;continue}const s=this.prefixedElementClassNames(t);for(const e of s)if(!i.indexOf(e)&&(delete i[e],!--r)){u=!0;break}}let l=n.toLowerCase();if(i&&"input"===n.toLowerCase()&&e.getAttribute("type")&&!e.getAttribute("id")&&!e.getAttribute("class")&&(l+='[type="'+e.getAttribute("type")+'"]'),u)l+=":nth-child("+(h+1)+")";else if(c)for(const d in o)l+="."+this.escapeIdentifierIfNeeded(o[d]?.substr(1)||"");return new CSSPathStep(l,!1)}prefixedElementClassNames(e){const t=e.getAttribute("class");return t?t.split(/\s+/g).filter(Boolean).map((e=>"$"+e)):[]}idSelector(e){return"#"+this.escapeIdentifierIfNeeded(e)}escapeIdentifierIfNeeded(e){if(this.isCSSIdentifier(e))return e;const t=/^(?:[0-9]|-[0-9-]?)/.test(e),i=e.length-1;return e.replace(/./g,((e,r)=>t&&0===r||!this.isCSSIdentChar(e)?this.escapeAsciiChar(e,r===i):e))}escapeAsciiChar(e,t){return"\\"+this.toHexByte(e)+(t?"":" ")}toHexByte(e){let t=e.charCodeAt(0).toString(16);return 1===t.length&&(t="0"+t),t}isCSSIdentChar(e){return!!/[a-zA-Z0-9_-]/.test(e)||e.charCodeAt(0)>=160}isCSSIdentifier(e){return/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(e)}}const St=(new PulseModule).provide((function(i){return i.useFactory(CoreConfigurations,(e=>e),[s]).useClass(CryptoService,CryptoService,[]).useClass(CookieParser,CookieParser,[]).useClass(LoggerService,LoggerService,[PersistentStorage,CoreConfigurations]).useClass(DebugService,DebugService,[PersistentStorage,CoreConfigurations]).useClass(FeatureToggleService,FeatureToggleService,[]).useClass(TransientStorage,TransientStorage,[]).useValue(e,window).useClass(AnalyticsEnvironment,AnalyticsEnvironment,[e]).useClass(DateService,DateService,[AnalyticsEnvironment]).useClass(HttpService,HttpService,[DocumentVisibilityTracker,AnalyticsEnvironment,DateService,LoggerService,CoreConfigurations,DeviceIdService]).useClass(UUIDService,UUIDService,[DateService,AnalyticsEnvironment]).useClass(DeviceInfoService,DeviceInfoService,[AnalyticsEnvironment,DateService]).useClass(LoggerService,LoggerService,[PersistentStorage,CoreConfigurations]).useClass(AnalyticsTransport,AnalyticsTransport,[DebugService,CoreConfigurations,HttpService]).useClass(PageInfoService,PageInfoService,[AnalyticsEnvironment]).useFactory(DeviceIdService,((e,t,i)=>new DeviceIdService(e,t(i.sessionStorageType))),[UUIDService,r,CoreConfigurations]).useFactory(t,((e,t)=>new PulseBroadcastChannel("pulse-cookie-changes",e,t)),[PersistentStorage,AnalyticsEnvironment]).useFactory(HashStore,((e,t,i,r)=>new HashStore(i(r.hashStoreStorageType),e,t)),[CryptoService,DateService,r,CoreConfigurations]).useFactory(TabManagerService,(async(e,t,i,r)=>{const n=new TabManagerService(e(r.tabManagerStorageType),t,i,r);return await n.init(),n}),[r,LockManager,UUIDService,CoreConfigurations]).useFactory(TabInfoService,((e,t,i,r,n,s)=>new TabInfoService(e(s.sessionStorageType),t,i,r,n,s)),[r,DocumentVisibilityTracker,ActivityTracker,ActivitySynchronizer,DateService,CoreConfigurations]).useFactory(TabOpenerDetector,((e,t,i,r,n,s,o)=>new TabOpenerDetector(e,t(o.tabManagerStorageType),i,r,n,s,o)),[TabInfoService,r,ActivitySynchronizer,TabManagerService,DateService,AnalyticsEnvironment,CoreConfigurations]).useFactory(t,((e,t)=>new PulseBroadcastChannel("pulse-cookie-changes",e,t)),[PersistentStorage,AnalyticsEnvironment]).useClass(CookieChangeDetector,CookieChangeDetector,[t,AnalyticsEnvironment]).useClass(PersistentStorage,PersistentStorage,[AnalyticsEnvironment,CoreConfigurations]).useClass(TabStorage,TabStorage,[AnalyticsEnvironment,CoreConfigurations]).useClass(CookieStorage,CookieStorage,[AnalyticsEnvironment,CookieParser,CookieChangeDetector,CoreConfigurations]).useClass(Quote,Quote,[]).useClass(IndexedDBService,IndexedDBService,[AnalyticsEnvironment]).useFactory(n,((e,t,i,r)=>new CookieStorage(e,t,i,{...r,storagePrefix:""})),[AnalyticsEnvironment,CookieParser,CookieChangeDetector,CoreConfigurations]).useFactory(r,((e,t,i)=>r=>{switch(r){case"memory":return e;case"persistent":return i;case"tab":return t}}),[TransientStorage,TabStorage,PersistentStorage]).useClass(NativeLockManager,NativeLockManager,[AnalyticsEnvironment,UUIDService]).useClass(UnsafeLockManager,UnsafeLockManager,[PersistentStorage,DateService,CoreConfigurations,UUIDService,DocumentVisibilityTracker]).useFactory(LockManager,(async(e,t)=>await e.supported()?e:t),[NativeLockManager,UnsafeLockManager]).useClass(ExperimentDebugService,ExperimentDebugService,[PersistentStorage,PageInfoService,AnalyticsEnvironment,CoreConfigurations]).useClass(DOMPath,DOMPath,[]).useFactory(ActivitySynchronizer,((e,t,i,r)=>new ActivitySynchronizer(e("persistent"),t,i,r)),[r,ActivityTracker,DateService,CoreConfigurations]).useClass(ActivityTracker,ActivityTracker,[DocumentVisibilityTracker,AnalyticsEnvironment,TabManagerService,CoreConfigurations]).useClass(DocumentVisibilityTracker,DocumentVisibilityTracker,[AnalyticsEnvironment]).useFactory(o,((e,t)=>e.win[t.dataLayerKey]),[AnalyticsEnvironment,CoreConfigurations]).useFactory(a,(e=>e.win.pulse?.q),[AnalyticsEnvironment]).useClass(EventAdapterService,EventAdapterService,[AnalyticsEnvironment]).useClass(DataLayerService,DataLayerService,[AnalyticsEnvironment]).useFactory(LocationHistoryTracker,(async(e,t,i,r)=>new LocationHistoryTracker(e,t(i.tabManagerStorageType),r)),[AnalyticsEnvironment,r,CoreConfigurations,DateService]).useClass(RUMService,RUMService,[PerformanceTimelineService,RequestMonitorService]).useClass(RequestMonitorService,RequestMonitorService,[FetchCollectorService,XHRCollectorService,PerformanceTimelineService,DateService,AnalyticsEnvironment]).useClass(PerformanceTimelineService,PerformanceTimelineService,[AnalyticsEnvironment,CSSPathService,DateService,DocumentVisibilityTracker]).useClass(CSSPathService,CSSPathService,[]).useClass(FetchCollectorService,FetchCollectorService,[DateService,AnalyticsEnvironment]).useClass(XHRCollectorService,XHRCollectorService,[DateService,AnalyticsEnvironment])})).beforeInit((function(e){const t={...u,...e,initialDocURL:window.paa?.idu};return"standard"!==t.mode&&(t.hashStoreStorageType="memory",t.attributesStorageType="memory",t.tabManagerStorageType="memory",t.serverCookies=!1),t}));class SettingsConfigurations{}const wt={pulseClientType:"browser",settingsBaseURL:"https://optifyr.com/web/v2",cacheStorageType:"persistent",timeout:3e3,cacheTimeout:6e5,defaults:{},storagePrefix:"paa_",remoteSettingEnabled:!0};class ExperimentsService{constructor(e,t,i,r,n,s){this.pulseStorage=e,this.dateService=t,this.responseTrackerService=i,this.cacheService=r,this.usageTrackerService=n,this.eventAdapterService=s,this.experimentStorageKey="experiments",this.experiments=[],this.experiments=this.pulseStorage.getJSON(this.experimentStorageKey),this.responseTrackerService.responses().subscribe((e=>{this.cacheResponse(e)})),this.usageTrackerService.usages().subscribe((e=>{const i=this.findUnparticipatedExperiment(e.key);i&&(this.eventAdapterService.push({pulse:"event",event:"experiment_participate",data:{experiment_id:i.name,variant:i.variant}}),i.participation_date=t.now(),this.experiments&&this.cacheExperiments(this.experiments))})),this.pulseStorage.change(this.experimentStorageKey).subscribe((e=>{e.value?this.experiments=JSON.parse(e.value):this.experiments=[]}))}getExperiments(){return this.pulseStorage.getJSON(this.experimentStorageKey)||[]}getExperimentsString(){return this.getExperiments().map((e=>`${e.name}:${e.variant}`)).join(",")}cacheResponse(e){if(!e.experiments)return;const t=this.findNewExperiments(e.experiments);t&&this.cacheService.removeCachedSettings(t),this.cacheExperiments(e.experiments)}cacheExperiments(e){const t=this.dateService.now(),i=this.getExperiments(),r=e.map((e=>{let r;if(i){const t=i.find((t=>t.name===e.name));r=t?.participation_date||e?.participation_date||null}else r=null;return{...e,participation_date:r,time:t}}));this.pulseStorage.remove(this.experimentStorageKey),this.pulseStorage.set(this.experimentStorageKey,JSON.stringify(r)),this.experiments=r}findNewExperiments(e){const t=this.getExperiments();if(!t)return null;return e.filter((e=>-1===t.findIndex((t=>t.name===e.name))))}findUnparticipatedExperiment(e){if(!this.experiments||!this.experiments.length)return null;for(const t of this.experiments)if(t.settings?.includes(e)&&!t.participation_date)return t;return null}}class SegmentsResolverService{constructor(e,t,i,r){this.responseTracker=e,this.storage=t,this.deviceId=i,this.date=r,this.storageKey=`segments-${this.deviceId.getDeviceId().substring(0,5)}`,this.responseTracker.responses().subscribe((e=>{Array.isArray(e.segments)&&this.persist(e.segments)}))}async getSegments(){const e=this.read();return e?.segments||[]}persist(e){this.storage.setJSON(this.storageKey,{segments:e,ts:this.date.now()})}read(){return this.storage.getJSON(this.storageKey)}}class PulseSettings{constructor(e,t,i,r,n,s,o,a,c,u,h,l,d,p,g,f){this.httpService=e,this.config=t,this.cacheService=i,this.responseTrackerService=r,this.experimentsService=n,this.experimentDebugService=s,this.usageTrackerService=o,this.deviceIdService=a,this.lockManager=c,this.queueService=u,this.hashStore=h,this.pulseStorage=l,this.userRoleService=d,this.isTestService=p,this.env=g,this.segmentsResolver=f,this.firstCallState={firstCallDone:!1,defaultReturned:!1},this.timeoutLimit=1500,this.state={},this.KEY_SESSION_STATE="ss",this.lock=[],this.renewRequested=!1,this.userRoleService.setFromQueryParams(),this.isTestService.setFromQueryParams(),this.getPrefetchSettings(),this.experimentDebugService.getDebugExperiment(),this.stateUpdateTask=this.refreshUserId(),this.pulseStorage.change(this.KEY_SESSION_STATE,"full","all").subscribe((({value:e})=>{this.stateUpdateTask=this.refreshUserId(JSON.parse(e||"{}"))}))}async get(e,t,i,r=!0){this.env.win.performance.mark("pulse_settingGetStart");const n=i?i[t]:this.config.defaults[t];if(!r)return this.env.win.performance.mark("pulse_settingGetEnd"),this.env.win.performance.measure("pulse_settingGetDefaultExecution","pulse_settingGetStart","pulse_settingGetEnd"),this.usageTrackerService.trackUsage(e,t,n);if(this.firstCallState.firstCallDone&&this.firstCallState.defaultReturned)return this.env.win.performance.mark("pulse_settingGetEnd"),this.env.win.performance.measure("pulse_settingGetDefaultExecution","pulse_settingGetStart","pulse_settingGetEnd"),this.usageTrackerService.trackUsage(e,t,n);await this.stateUpdateTask;const s=this.experimentDebugService.getDebugExperiment(),o=s?`${this.config.app}:${s.id}:${s.variant}`:null;let a;this.hashStore.changed("debug-experiment",o)&&await this.cacheService.clearCache(),this.env.win.performance.mark("pulse_getCacheStart");const c=await this.cacheService.getCachedSettings(t),u="string"==typeof c?.cachedSetting.emptyForTags?c.cachedSetting.emptyForTags.split(","):[];this.env.win.performance.mark("pulse_getCacheEnd"),this.env.win.performance.measure("pulse_getCacheExecution","pulse_getCacheStart","pulse_getCacheEnd");const h=this.userRoleService.getValue()||"",l=this.isTestService.getValue(),d=c?.cachedSetting.ur||"";if(c?.cachedSetting&&h!==d&&(c.timedOut=!0,this.renewSettings(h)),!c?.timedOut&&void 0===c?.cachedSetting[t]&&u.includes(e))return this.usageTrackerService.trackUsage(e,t,n);if(void 0!==c&&c.cachedSetting&&!c.timedOut&&void 0!==c.cachedSetting[t])return this.env.win.performance.mark("pulse_settingGetEnd"),this.env.win.performance.measure("pulse_settingGetCacheExecution","pulse_settingGetStart","pulse_settingGetEnd"),this.usageTrackerService.trackUsage(e,t,c.cachedSetting[t]);if(this.lock.includes(e))return await this.queueService.waitQueueOpen(e,this.config.timeout,this.lock),await this.getFromCacheAndReturn(t,n,e);this.lock.push(e);if(await this.lockManager.locked(e))return await this.queueService.waitQueueOpen(e,this.config.timeout,this.lock),await this.getFromCacheAndReturn(t,n,e);{this.lock.includes(e)||this.lock.push(e);const i=await this.lockManager.request(e,this.config.timeout);a=await this.fetchSettings(e,h,l,t,u);const r=a?.body?.settings;let s=r&&r[t];return void 0===s&&(s=c?.cachedSetting[t]||n),this.lock.includes(e)&&this.lock.splice(this.lock.indexOf(e),1),i&&this.lockManager.release(i),this.env.win.performance.mark("pulse_settingGetEnd"),this.env.win.performance.measure("pulse_settingGetFreshExecution","pulse_settingGetStart","pulse_settingGetEnd"),this.usageTrackerService.trackUsage(e,t,s)}}getSegments(){return this.segmentsResolver.getSegments()}async getFromCacheAndReturn(e,t,i){this.lock.includes(i)&&this.lock.splice(this.lock.indexOf(i),1);const r=await this.cacheService.getCachedSettings(e);let n;if(r?.cachedSetting&&void 0!==r?.cachedSetting[e])n=r?.cachedSetting[e];else{const t="string"==typeof r?.cachedSetting.emptyForTags?r.cachedSetting.emptyForTags.split(","):[];t.includes(i)||t.push(i),await this.cacheService.cacheSettings({[e]:void 0},i,t)}return n=void 0!==n?n:t,this.env.win.performance.mark("pulse_settingGetEnd"),this.env.win.performance.measure("pulse_settingGetCacheExecution","pulse_settingGetStart","pulse_settingGetEnd"),this.usageTrackerService.trackUsage(i,e,n)}async fetchSettings(e,t,i,r,n){if(!this.config.app)throw new Error("Application name has not been provided to settings SDK!");const s=this.composeRequestURL(e,t,i);return new Promise((t=>{setTimeout((()=>t(this.createFakeResponse(e))),this.timeoutLimit);this.httpService.get(s.href,{},"high").then((i=>{this.handleResponse(e,i,t,r,n)})).catch((()=>t(this.createFakeResponse(e))))}))}composeRequestURL(e,t,i){const r=this.config.app,n=this.deviceIdService.getDeviceId(),s=this.experimentsService.getExperimentsString(),o=this.experimentDebugService.getDebugExperiment(),a=new URL(`${this.config.settingsBaseURL}/${r}/${e}`);return a.searchParams.set("did",n),this.userId&&a.searchParams.set("uid",`${this.userId}`),s&&a.searchParams.set("exp",s),o&&a.searchParams.set("debug-exp",`${o.id}:${o.variant}`),t&&a.searchParams.set("ur",t),i&&a.searchParams.set("is-test",i),a}handleResponse(e,t,i,r,n){i(t),this.cacheResponse(t,e,r,n)}async cacheResponse(e,t,i,r){let n;n=e.body instanceof ReadableStream&&e instanceof Response?await e.clone().json():e.body;const s={settings:n.settings,experiments:n.experiments,segments:n.segments,tag:t,emptyForTags:r};e&&"object"==typeof e&&200===e?.status&&n?.settings&&(this.firstCallState.firstCallDone||(this.firstCallState.firstCallDone=!0,this.firstCallState.defaultReturned=!1),"object"!=typeof s.settings||null===s.settings||i in s.settings||(r.push(t),s.settings[i]=void 0),this.responseTrackerService.trackResponse(s))}createFakeResponse(e){return this.firstCallState.firstCallDone||(this.firstCallState.firstCallDone=!0,this.firstCallState.defaultReturned=!0),{ok:!1,body:{settings:[],experiments:[],segments:[],tag:e,emptyForTags:[]},headers:new Map([]),status:null}}async refreshUserId(e){const t=e||this.pulseStorage.getJSON(this.KEY_SESSION_STATE)||this.state||{};this.userId=t.user_id;this.hashStore.changed("user_id",this.userId,void 0,!1)&&await this.cacheService.clearCache().catch(console.error)}getPrefetchSettings(){let e="";if(document?.currentScript instanceof HTMLScriptElement){e=new URLSearchParams(document?.currentScript.src).get("prefetch")}else e=this.getPrefetchTags();e&&e.split(",").forEach((e=>{this.get(e,`${this.config.storagePrefix}${e}_prefetched`)}))}async renewSettings(e){if(this.renewRequested)return;this.renewRequested=!0;const t=await this.cacheService.getAllTags(e);this.cacheService.clearCache();const i=Array.from(t).filter((e=>!this.lock.includes(e)));i.length&&i.forEach((e=>{this.get(e,`${this.config.storagePrefix}${e}_prefetched`)})),this.renewRequested=!1}getPrefetchTags(){let e="";const t=document.getElementsByTagName("script");for(let i=0;i<t.length;i++){const r=t[i].getAttribute("src");if(r&&r.match(/^(https?|http):\/\/[^/]+\/pulse\/[^/]+\/(module\/|nomodule\/)?pulse\.js/i)){e=new URL(r).searchParams.get("prefetch")||e}}return e}}class QueryParamsService{constructor(e,t){this.pulseStorage=e,this.STORAGE_KEY=t,this.value=null,this.subscribeToChanges()}subscribeToChanges(){this.pulseStorage.change(this.STORAGE_KEY).subscribe((e=>{this.value=e.value}))}getValue(){return this.value}setFromQueryParams(){if(this.value=this.pulseStorage.get(this.STORAGE_KEY),null===this.value&&document?.currentScript instanceof HTMLScriptElement){const e=new URLSearchParams(document?.currentScript.src);this.value=e.get(this.STORAGE_KEY)}}}class UserRoleService extends QueryParamsService{constructor(e,t="ur"){super(e,t),this.pulseStorage=e,this.STORAGE_KEY=t}}class IsTestService extends QueryParamsService{constructor(e,t="is-test"){super(e,t),this.pulseStorage=e,this.STORAGE_KEY=t}}class PulseSettingsFactory{constructor(e){this.settingsService=e}createPulseSettings(e,t=!0){const i=this.settingsService;return{get:(r,n)=>i.get(r,n,e,t),getSegmentsIds:()=>i.getSegments()}}}class CacheService{constructor(e,t,i,r,n,s){this.indexedDBService=e,this.dateService=t,this.responseTrackerService=i,this.quote=r,this.config=n,this.pulseStorage=s,this.settingStorageKey="settingsStore",this.storedSettings={},this.responseTrackerService.responses().subscribe((e=>{e.settings&&e.tag&&this.cacheSettings(e.settings,e.tag,e.emptyForTags)}))}async clearCache(){await this.indexedDBService.truncate(this.settingStorageKey),this.storedSettings={}}async getCachedSettings(e){const t=await this.indexedDBService.getValue(this.settingStorageKey,e),i=this.storedSettings[e];if(null!=t){return{cachedSetting:t,timedOut:t.time+this.config.cacheTimeout<this.dateService.now()}}if(i){return{cachedSetting:i,timedOut:i.time+this.config.cacheTimeout<this.dateService.now()}}}async cacheSettings(e,t,i){const r=this.dateService.now(),n=await this.quote.quoteSize(),s=(new TextEncoder).encode(JSON.stringify(e)).length,o=n&&n-s>1e6,a=this.pulseStorage.get("ur");for(const[c,u]of Object.entries(e)){const e=i.join();o||null===n?await this.indexedDBService.putValue(this.settingStorageKey,{id:c,[c]:u,time:r,tag:t,emptyForTags:e,ur:a}):this.storedSettings[c]={[c]:u,time:r,tag:t,emptyForTags:e,ur:a}}await this.clearTimedOutSettings(t).catch(console.error)}removeCachedSettings(e){e.forEach((e=>{e?.settings?.length&&e.settings.forEach((e=>{this.indexedDBService.deleteValue(this.settingStorageKey,e),delete this.storedSettings[e]}))}))}async clearTimedOutSettings(e){for(const[t,i]of Object.entries(this.storedSettings))i.tag===e&&i.time<this.dateService.now()-this.config.cacheTimeout&&delete this.storedSettings[t];(await this.indexedDBService.getAllValue(this.settingStorageKey)).forEach((t=>{t.tag===e&&t.time<this.dateService.now()-this.config.cacheTimeout&&this.indexedDBService.deleteValue(this.settingStorageKey,t.id)}))}async getAllTags(e){const t=await this.indexedDBService.getAllValue(this.settingStorageKey),i=this.storedSettings,r=new Set;if(null!=t)t.forEach((t=>{t.ur!==e&&r.add(t.tag)}));else if(i)for(const[n]of Object.entries(i))i[n].ur!==e&&r.add(i[n].tag);return r}}class QueueService{constructor(e){this.lockManager=e}async waitQueueOpen(e,t,i=[]){let r=0;do{if(await this.lockManager.locked(e))await Te(50),r+=50;else{if(!i.includes(e))return e;await Te(50),r+=50}}while(r<t);return console.error("Request Timed Out"),null}}class ResponseTrackerService{constructor(e){this.dataLayerService=e,this.responses$=new we}responses(){return this.responses$.asObservable()}trackResponse(e){this.responses$.next(e);const t=e.experiments?.filter((e=>e?.trackable)),i={pulse:"state",segments:e.segments};return t&&(i.experiments=t),this.dataLayerService.pushData(i),e}}class UsageTrackerService{constructor(){this.usage$=new we}usages(){return this.usage$.asObservable()}trackUsage(e,t,i){if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}(i)){const r=this.usage$;return new Proxy(i,{get:(n,s)=>(Object.hasOwn(n,s)&&r.next({tag:e,key:t,value:i}),n[s])})}return this.usage$.next({tag:e,key:t,value:i}),i}}const _t=(new PulseModule).provide((function(e){return e.useFactory(SettingsConfigurations,(e=>e),[s]).useFactory(ExperimentsService,((e,t,i,r,n,s,o)=>new ExperimentsService(e(t.cacheStorageType),i,r,n,s,o)),[r,SettingsConfigurations,DateService,ResponseTrackerService,CacheService,UsageTrackerService,EventAdapterService]).useClass(SegmentsResolverService,SegmentsResolverService,[ResponseTrackerService,PersistentStorage,DeviceIdService,DateService]).useFactory(PulseSettings,((e,t,i,r,n,s,o,a,c,u,h,l,d,p,g,f)=>new PulseSettings(i,t,r,n,s,o,a,c,u,h,l,e(t.cacheStorageType),d,p,g,f)),[r,SettingsConfigurations,HttpService,CacheService,ResponseTrackerService,ExperimentsService,ExperimentDebugService,UsageTrackerService,DeviceIdService,LockManager,QueueService,HashStore,UserRoleService,IsTestService,AnalyticsEnvironment,SegmentsResolverService]).useClass(QueueService,QueueService,[LockManager]).useFactory(CacheService,((e,t,i,r,n,s)=>new CacheService(i,r,n,s,t,e(t.cacheStorageType))),[r,SettingsConfigurations,IndexedDBService,DateService,ResponseTrackerService,Quote]).useClass(UsageTrackerService,UsageTrackerService,[]).useClass(ResponseTrackerService,ResponseTrackerService,[DataLayerService]).useClass(PulseSettingsFactory,PulseSettingsFactory,[PulseSettings]).useFactory(UserRoleService,((e,t)=>new UserRoleService(t(e.cacheStorageType))),[SettingsConfigurations,r]).useFactory(IsTestService,((e,t)=>new IsTestService(t(e.cacheStorageType))),[SettingsConfigurations,r])})).beforeInit((function(e){return{...wt,...e}})).onInit((async(e,t)=>{await t.connectDB()}),[IndexedDBService]);function Et(e){if("string"!=typeof e)throw new Error("Invalid input. Input must be a string");const t=e.match(/(\/?)(.+)\1([a-z]*)/i);return t?t[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3])?RegExp(e):new RegExp(t[2],t[3]):null}class PipeHost{constructor(){this.transformPipes=[],this.enrichmentPipes=[]}process(e,t){return this.transform(e,t).map((e=>this.enrich(e,t)))}transform(e,t){const i=this.selectPipeSet(e,this.transformPipes);let r=[e];for(const n of i){if(!n.transform)continue;const e=[];for(const i of r){const r=n.transform(i,t);e.push(...r)}r=e}return r}enrich(e,t){return this.selectPipeSet(e,this.enrichmentPipes).reverse().reduce(((e,i)=>i.enrich(e,t)),e)}registerTransformSet(e){this.transformPipes.push(e)}registerEnrichmentSet(e){this.enrichmentPipes.push(e)}selectPipeSet(e,t){for(const i of t){if(!("*"===i.selector||i.selector===e.type||"function"==typeof i.selector&&i.selector(e)||!1))continue;if(!("function"==typeof i.exclude&&i.exclude(e)))return[...i.use]}return[]}}class AttributeSpreadPipe{transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];if(!("object"==typeof t&&"string"==typeof t?.name&&["$overwrite","$inc","$dec"].indexOf(t?.operation)>-1)&&"object"==typeof t&&t){const i=[];for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const n=t[r];if(!("string"==typeof n||"number"==typeof n||"boolean"==typeof n))continue;const s={...e,data:{operation:"$overwrite",name:r,value:n}};i.push(s)}return i}return[e]}}class ActionParamEventPipe{transform(e){const t={...e.data};return"string"==typeof t.event&&t.event||"string"!=typeof t.action||!t.action||(t.event=t.action,delete t.action),"object"==typeof t.data&&t.data||("object"==typeof t.parameters&&t.parameters?(t.data=t.parameters,delete t.parameters):t.data={}),e.data=t,[e]}}class ChangedAttributesPipe{constructor(e,t){this.hashStore=e,this.config=t}transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];const i=`attribute_${t.name}`,r=`${t.operation}_${t.value}`;return this.hashStore.changed(i,r,this.config.attributeTimeoutMS)?[e]:[]}}class EventGlobalsPipe{constructor(e,t,i,r,n,s){this.historyTracker=e,this.tabManager=t,this.pageInfo=i,this.config=r,this.openerDetector=n,this.uuidService=s}enrich(e){const t={...e.data};if("object"==typeof t.data&&null!==t.data||(t.data={}),t.timestamp=e.timestamp,t.event_id=this.uuidService.generate(),t.metadata={event_id_source:"sdk"},Ge(this.config.eventEnrichment,"url")&&(t.data.url=this.pageInfo.href()),Ge(this.config.eventEnrichment,"tab_id")&&(t.data.tab_id=this.tabManager.getTabId(),t.data.tab_id)){const e=this.openerDetector.getOpener();e?.id&&(t.data.opener_tab_id=e.id)}return this.historyTracker.previousUrl&&Ge(this.config.eventEnrichment,"previous_url")&&(t.data.previous_url=this.historyTracker.previousUrl),this.pageInfo.referrer()&&Ge(this.config.eventEnrichment,"referrer")&&(t.data.referrer=this.pageInfo.referrer()),e.data=t,e}}class LegacySourcePipe{constructor(e,t){this.sourceService=e,this.config=t}enrich(e){if(!Ge(this.config.eventEnrichment,"legacy_source"))return e;const t={...e.data};"object"==typeof t.data&&null!==t.data||(t.data={});const i=t?.data?.source;if(!0===i||"string"==typeof i&&"true"===i.toLowerCase()){const e=this.sourceService.getSource();t.data.source=e}else void 0!==i&&"string"!=typeof i&&(t.data.source=JSON.stringify(i)||"");return e.data=t,e}}class PluginHost{constructor(){this.plugins=[]}init(e){this.plugins.forEach((t=>t.init&&t.init(e)))}enqueue(e,t){return this.plugins.every((i=>!i.enqueue||i.enqueue(e,t)))}beforeBatchSend(e,t){return this.plugins.reduce(((e,i)=>e&&i.beforeBatchSend?i.beforeBatchSend(e,t):e),e)}batchSent(e,t){this.plugins.forEach((i=>i.batchSent&&i.batchSent(e,t)))}sessionChange(){throw new Error("Method not implemented.")}stateChange(){throw new Error("Method not implemented.")}register(e){this.plugins.push(e)}}var kt;!function(e){e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden"}(kt||(kt={}));class VisibilityChangePlugin{constructor(e){this.visibility=e,this.visibilityState=kt.Visible}init(){this.visibility.onVisibilityChange().subscribe((e=>{this.visibilityState=e?kt.Visible:kt.Hidden}))}}class NavigationEventPlugin{constructor(e,t,i,r){this.historyTracker=e,this.navigationEventService=t,this.sessionService=i,this.consentService=r}init(){this.navigationEventService.send(!0),this.sessionService.session.subscribe((e=>{(e.isRenew||e?.renewedBy)&&this.consentService.trackingEnabled()&&this.navigationEventService.send(!1,e?.renewedBy)})),this.historyTracker.navigation.subscribe((()=>this.navigationEventService.send(!1)))}}var Tt,Ct=Array.isArray,Pt=Object.getPrototypeOf,It=Object.prototype,xt=Object.keys;function At(e){if(1===e.length){var t=e[0];if(Ct(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&Pt(r)===It){var i=xt(t);return{args:i.map((function(e){return t[e]})),keys:i}}}var r;return{args:e,keys:null}}function Nt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Ae(e),r=function(e){return w(xe(e))?e.pop():void 0}(e),n=At(e),s=n.args,o=n.keys;if(0===s.length)return Re([],i);var a=new Y(function(e,t,i){void 0===i&&(i=G);return function(r){Ot(t,(function(){for(var n=e.length,s=new Array(n),o=n,a=n,c=function(n){Ot(t,(function(){var c=Re(e[n],t),u=!1;c.subscribe(ae(r,(function(e){s[n]=e,u||(u=!0,a--),a||r.next(i(s.slice()))}),(function(){--o||r.complete()})))}),r)},u=0;u<n;u++)c(u)}),r)}}(s,i,o?function(e){return function(e,t){return e.reduce((function(e,i,r){return e[i]=t[r],e}),{})}(o,e)}:G));return r?a.pipe(pe(r)):a}function Ot(e,t,i){e?he(i,e,t):t()}class StatePlugin{constructor(e,t,i){this.sessionService=e,this.debug=t,this.config=i}init(){Nt([this.sessionService.session,this.debug.items]).subscribe((([e])=>{this.setState(e)}))}setState(e){const{app:t}=e,i=this.getLanguage(),r={app:Ge(this.config.stateEnrichment,"app")?t:void 0,market:Ge(this.config.stateEnrichment,"market")?"web":void 0,platform:Ge(this.config.stateEnrichment,"platform")?"web":void 0,version:Ge(this.config.stateEnrichment,"version")?"0":void 0,language_code:Ge(this.config.stateEnrichment,"language_code")?i:void 0,v:Ge(this.config.stateEnrichment,"pulse_version")?this.config.version:void 0,debug:this.debug.enabled("debugger")};this.sessionService.setState(r)}getLanguage(){return(navigator.language||navigator.languages[0]||"unknown").split("-").shift()||"unknown"}}class PopupEventPlugin{constructor(e,t){this.activityTracker=e,this.env=t}init(){this.activityTracker.mutations().pipe(le((e=>e.addedElements))).subscribe((e=>{this.env.win.dataLayer?.push({pulse:"event",event:"popup",data:{component:e.component,component_type:e.componentType,popup_source:{section:e.section.name,group:e.section.group},click_source:{tab_id:this.activityTracker.lastClickSourceInformation?.tab_id,url:this.activityTracker.lastClickSourceInformation?.url,section:this.activityTracker.lastClickSourceInformation?.name,group:this.activityTracker.lastClickSourceInformation?.group,element:{id:this.activityTracker.lastClickSourceInformation?.element?.id,name:this.activityTracker.lastClickSourceInformation?.element?.name,node_type:this.activityTracker.lastClickSourceInformation?.element?.nodeName,class_list:this.activityTracker.lastClickSourceInformation?.element?.classList}}}})}))}}class DeviceAttributesPlugin{constructor(e){this.attributeService=e}init(){this.attributeService.send()}}!function(e){e[e.Normal=1]="Normal",e[e.High=2]="High",e[e.Force=3]="Force"}(Tt||(Tt={}));class ConsentEventPlugin{constructor(e,t,i,r){this.consentService=e,this.sessionService=t,this.attributeService=i,this.env=r}init(){this.consentService.changes().pipe(be((e=>!1!==e.consent.report))).subscribe((e=>{this.fireChangeEvent(e),"opt-in"===e.consent.mode&&(this.sessionService.startNewSession("consent_change"),this.attributeService.send())}))}fireChangeEvent(e){const t={event:"consent_change",data:this.buildChangeEvent(e)};this.env.win.dataLayer?.push({pulse:"event",...t,event_priority:Tt.Force})}buildChangeEvent({consent:e,result:t}){const i="string"==typeof e.consent?e.consent:e.consent.name;return{mode:e.mode,provider:i,state:t.state,necessary_cookies:t.necessary_cookies??void 0,performance_cookies:t.performance_cookies??void 0,functional_cookies:t.functional_cookies??void 0,targeting_cookies:t.targeting_cookies??void 0,social_media_cookies:t.social_media_cookies??void 0,provider_consent_id:t.provider_consent_id??void 0,response_time:t.response_time??void 0}}}function Dt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Ce(1)(Re(e,Ae(e)))}class FacebookPixelAttributePlugin{constructor(e,t,i,r){this.cookieStorage=e,this.hashStore=t,this.attributeService=i,this.env=r}init(){this.getPixelId()}getPixelId(){const e=this.cookieStorage.get("_fbp"),t=this.cookieStorage.change("_fbp","full","all").pipe(ue((e=>e.value)));Dt(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Re(e,Ae(e))}(e),t).pipe(be(Boolean),be((e=>this.hashStore.changed("pixel_id_attr",e)))).subscribe((e=>{this.env.win.dataLayer?.push({pulse:"attribute",fb_pixel_id:e}),this.attributeService.send(!0)}))}}class SessionStartEventPlugin{constructor(e,t,i,r){this.hashStore=e,this.trafficSourceService=t,this.sessionService=i,this.env=r,this.lockedLocal=""}init(e){this.sessionService.session.subscribe((t=>{this.fireEvent(t,e)}));const t=this.sessionService.getSession();this.fireEvent(t,e)}async fireEvent(e,t){if(this.lockedLocal===e.sessionId)return;if(this.lockedLocal=e.sessionId,!this.isNewSession(e))return;const i=this.trafficSourceService.getTrafficSource(),r={event:"session_start",data:{}};i?.clickId?.value&&(r.data.mkt_click={id:i.clickId.value,source:i.clickId.source}),i?.landingPageURL&&(r.data.landing_page_url=i?.landingPageURL),i?.utmParams&&(r.data.utm_params=i.utmParams),e.renewedBy&&(r.data.source=e.renewedBy),this.env.win.dataLayer?.push({pulse:"event",...r,event_priority:Tt.High})}isNewSession(e){return this.hashStore.changed("session_start_event_session_id",e.sessionId)}}class RUMPlugin{constructor(e,t){this.rum=e,this.env=t}init(e){this.rum.subscribe(e.config.rumReport,e.config.rumReportOnce).subscribe((e=>{this.env.win.dataLayer?.push({pulse:"event",event:"rum",data:e})}))}}class ContextMenuPlugin{constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(be((e=>"contextmenu"===e.type&&"link"===e.element?.nodeType&&!e.doNotTrack&&e.clickable))).subscribe((e=>{this.env.win.dataLayer?.push({pulse:"event",event:"contextmenu",data:{click_source:{section:e.section.name,group:e.section.group,element:{id:e.element?.id,name:e.element?.name,node_type:e.element?.nodeName,class_list:e.element?.classList}}}})}))}}class ClickEventPlugin{constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(be((e=>"click"===e.type&&!e.doNotTrack&&e.clickable))).subscribe((e=>{this.env.win.dataLayer?.push({pulse:"event",event:"click",data:{click_source:{section:e.section.name,group:e.section.group,element:{id:e.element?.id,name:e.element?.name,node_type:e.element?.nodeName,class_list:e.element?.classList}}}})}))}}class TabLinkingPlugin{constructor(e,t,i,r){this.activity=e,this.tabInfo=t,this.tabManager=i,this.config=r}init(){Ge(this.config.eventEnrichment,"tab_id")&&(this.activity.startService(this.tabManager.getTabId()),this.tabInfo.startService(this.tabManager.getTabId()))}}var Lt=function(e){function t(t,i){return e.call(this)||this}return l(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(C),Rt={setInterval:function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=Rt.delegate;return(null==n?void 0:n.setInterval)?n.setInterval.apply(n,v([e,t],f(i))):setInterval.apply(void 0,v([e,t],f(i)))},clearInterval:function(e){var t=Rt.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},Mt=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return l(t,e),t.prototype.schedule=function(e,t){var i;if(void 0===t&&(t=0),this.closed)return this;this.state=e;var r=this.id,n=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(n,r,t)),this.pending=!0,this.delay=t,this.id=null!==(i=this.id)&&void 0!==i?i:this.requestAsyncId(n,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),Rt.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;null!=t&&Rt.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i,r=!1;try{this.work(e)}catch(n){r=!0,i=n||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,i=this.scheduler,r=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,T(r,this),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(Lt),Ut=function(){function e(t,i){void 0===i&&(i=e.now),this.schedulerActionCtor=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},e.now=Qe.now,e}(),Bt=new(function(e){function t(t,i){void 0===i&&(i=Ut.now);var r=e.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return l(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var i;this._active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(Ut))(Mt),qt=Bt;class OneTrustConsentService{constructor(e){this.unPrefixedCookieStorage=e,this.cookieName="OptanonConsent",this.boxCookieName="OptanonAlertBoxClosed"}changes(){const e=this.parseOneTrustCookie(),t=new ke(e),i=new we;var r,n;return i.pipe((r=30,void 0===n&&(n=Bt),oe((function(e,t){var i=null,s=null,o=null,a=function(){if(i){i.unsubscribe(),i=null;var e=s;s=null,t.next(e)}};function c(){var e=o+r,s=n.now();if(s<e)return i=this.schedule(void 0,e-s),void t.add(i);a()}e.subscribe(ae(t,(function(e){s=e,o=n.now(),i||(i=n.schedule(c,r),t.add(i))}),(function(){a(),t.complete()}),void 0,(function(){s=i=null})))}))),ue((()=>this.parseOneTrustCookie()))).subscribe((e=>t.next(e))),this.unPrefixedCookieStorage.change(this.cookieName,"full","all").subscribe((()=>i.next())),this.unPrefixedCookieStorage.change(this.boxCookieName,"full","all").subscribe((()=>i.next())),t}parseOneTrustCookie(){const e=this.unPrefixedCookieStorage.get(this.cookieName)||"",t=new URLSearchParams(e||""),i=this.parseConsentGroups(t);if(!i)return{state:"pending"};const r=t.get("consentId")||void 0,n=this.getResponseTime(),s=!Number.isSafeInteger(n)||"true"===t.get("AwaitingReconsent"),o="boolean"==typeof i.C0001?i.C0001:void 0,a="boolean"==typeof i.C0002?i.C0002:void 0,c="boolean"==typeof i.C0003?i.C0003:void 0,u="boolean"==typeof i.C0004?i.C0004:void 0;return{state:s?"pending":"responded",response_time:n,provider_consent_id:r,necessary_cookies:o,functional_cookies:c,performance_cookies:a,social_media_cookies:"boolean"==typeof i.C0005?i.C0005:void 0,targeting_cookies:u}}parseConsentGroups(e){const t=(e.get("groups")||"").trim();if(t)return t.split(",").reduce(((e,t)=>{const i=(t||"").split(":").map((e=>e.trim())),r=i[0],n="1"===i[1]||"true"===i[1];return r&&2===i.length&&(e[r]=n),e}),{})}getResponseTime(){const e=this.unPrefixedCookieStorage.get(this.boxCookieName),t=e?new Date(e):void 0;return t?.getTime()||void 0}}class TrackingConsentService{constructor(e,t,i,r){this.oneTrust=e,this.logger=t,this.hashStore=i,this.config=r;const n=this.buildConsentChecks(this.config.consentChecks||[]),s=n.map((e=>e.result.pipe(ue((t=>({consent:{consent:e.consent,mode:e.mode,report:e.report,type:e.type},result:t}))))));this.consentChanges=Me(...s),this.trackerConsentStream=this.createTrackerCheckerStream(n)}trackingEnabled(){return this.trackerConsentStream}softChanges(){return this.consentChanges}changes(){return this.consentChanges.pipe(be((({consent:e,result:t})=>{const i="string"==typeof e.consent?e.consent:e.consent.name,r=`tracking_consent_${e.type}${i}`;return this.hashStore.changed(r,t)})))}createTrackerCheckerStream(e){const t=e.every((e=>"opt-out"===e.mode)),i=new ke(t),r=e.map((e=>e.result.pipe(ue((t=>{if("tracking"===e.type){if("boolean"==typeof t.performance_cookies)return t.performance_cookies;if("pending"===t.state)return"opt-out"===e.mode}return!0})))));return r.length&&Nt(r).pipe(ue((e=>e.every((e=>!0===e))))).subscribe((e=>i.next(e))),i.asObservable().pipe(Ue())}buildConsentChecks(e){const t=[];for(const i of e)if("tracking"===i.type)if("OneTrust"===i.consent){const e=this.oneTrust.changes();t.push({...i,result:e})}else if("object"==typeof i.consent&&"function"==typeof i.consent?.handler){const e=this.buildFunctionConsentChecker(i);t.push(e)}else this.logger.warn("Consent","Unsupported ConsentChecker!");else this.logger.warn("Consent","Unsupported ConsentCheck type!");return t}buildFunctionConsentChecker(e){const t=new Ye;if("object"==typeof e.consent&&"function"==typeof e.consent?.handler){const r=e.consent.handler(t.next.bind(t));"object"==typeof r&&((i=r)&&(i instanceof Y||w(i.lift)&&w(i.subscribe)))?r.subscribe(t):this.isPromise(r)?Re(r).subscribe(t):this.isValidResult(r)&&t.next(r)}var i;return{...e,result:t.pipe(be((e=>this.isValidResult(e))))}}isPromise(e){return e instanceof Promise||"object"==typeof e&&"function"==typeof e?.then}isValidResult(e){const t=e;return"object"==typeof t&&("pending"===t?.state||"responded"===t?.state)}}class LegacySourceService{constructor(e,t){this.utmService=e,this.page=t,this.engineList=new RegExp(["google","bing","baidub","yahoo","yandex","ask","duckduckgo","naver","aol","seznam"].join("|"))}getSource(){const e=(this.page.referrer()||"").replace(/^https?:\/\//,""),t=this.utmService.getUTMParams();return t?.utm_source?`utm_${t.utm_source}`:e?this.engineList.test(e)?`search_${e}`:`referral_${e}`:"direct"}}class UTMTrackerService{constructor(e){this.page=e}getUTMParams(){const e=new URL(this.page.landingPageUrl().toLowerCase()),t=e.searchParams.get("utm_source"),i=e.searchParams.get("utm_medium"),r=e.searchParams.get("utm_campaign"),n=e.searchParams.get("utm_term")||"",s=e.searchParams.get("utm_content")||"";if(t||r)return{utm_source:t||void 0,utm_medium:i||void 0,utm_campaign:r||void 0,utm_term:n||void 0,utm_content:s||void 0}}}function Ht(e,t){return e===t||"object"==typeof e&&"object"==typeof t&&Object.keys({...e,...t}).every((i=>Ht(e[i],t[i])))}class TrafficSourceService{constructor(e,t,i){this.utmService=e,this.storage=t,this.page=i}getTrafficSource(){const e=this.utmService.getUTMParams(),t=this.getClickId(),i=this.getReferrer(),r=this.page.landingPageUrl();return e||t||i?{utmParams:e,clickId:t,referrer:i,landingPageURL:r}:null}getLastTrafficSource(){const e=this.getStoredTrafficSource(),t=this.getTrafficSource(),i=t?.referrer?.internal??!1;return this.changed(t?.clickId,e?.clickId)||this.changed(t?.utmParams,e?.utmParams)||this.changed(t?.referrer,e?.referrer)&&!i?(this.storage.setJSON("traffic_source",t),t):e}getStoredTrafficSource(){return this.storage.getJSON("traffic_source")}getClickId(){const{searchParams:e}=new URL(this.page.landingPageUrl().toLowerCase()),t=e.get("gclid"),i=e.get("gclsrc"),r=e.get("msclkid"),n=e.get("fbclid"),s=e.get("yclid");let o,a;return t?(o=t,a=i?`google.${i}`:"google"):n?(o=n,a="facebook"):r?(o=r,a="microsoft"):s&&(o=s,a="yandex"),o&&a?{value:o,source:a}:void 0}getReferrer(){const e=this.page.referrer()||"";if(e)return{url:e,internal:this.isInternalURL(e)}}isInternalURL(e){return new URL(e).host===this.page.url().host}changed(e,t){return e&&!Ht(e,t)}}class SessionService{constructor(e,t,i,r,n,s,o="all"){this.date=e,this.storage=t,this.trafficSourceService=i,this.hashStore=r,this.config=n,this.deviceIdService=s,this.storageChange=o,this.newSessionGenerated$=new we,this.KEY_SESSION_STATE="ss",this.KEY_SESSION_ID="sid",this.KEY_DEVICE_ID="did",this.KEY_LAST_ACTIVITY="la",this.lastActivity=+(this.storage.get(this.KEY_LAST_ACTIVITY)||0),this.sessionId=this.storage.get(this.KEY_SESSION_ID)||void 0,this.registerStorageChangeListeners(),this.session=new ke(this.getSession())}setState(e){const t=this.getState(),i={...t,...e};var r,n;(r=t)===(n=i)||"object"==typeof r&&"object"==typeof n&&Object.keys({...r,...n}).every((e=>r[e]===n[e]))||(this.state=i,this.storage.setJSON(this.KEY_SESSION_STATE,i))}getState(){return this.state?this.state:this.refreshState()}getSession(e=!0,t=!1){const i=this.deviceIdService.getDeviceId(),r=this.storage.get(this.KEY_SESSION_ID),n=this.isSessionExpired(),s=!this.sessionId,o=!this.sessionId||n?this.fetchSessionId(n):this.sessionId;(n||s||t)&&this.setState({device_id:Ge(this.config.stateEnrichment,"device_id")?i:void 0,session_id:Ge(this.config.stateEnrichment,"session_id")?o:void 0});const a=this.getState(),c=this.lastActivity||0,u={app:this.config.app,deviceId:i,sessionId:o,lastActivity:c,state:a};return e&&this.refreshLastActivity(),n&&r&&(u.renewedBy="session_reset",u.isRenew=!0),(n||s)&&this.session?.next(u),u}refreshLastActivity(){const e=this.date.now();e-(this.lastActivity||0)>1e3&&(this.lastActivity=e,this.storage.set(this.KEY_LAST_ACTIVITY,this.lastActivity.toString()))}startNewSession(e){return this.sessionId=this.generateSessionId(),this.storage.set(this.KEY_SESSION_ID,this.sessionId),this.refreshLastActivity(),e&&this.session?.next({...this.getSession(!0,!0),renewedBy:e}),this.newSessionGenerated$.next(this.sessionId),this.sessionId}isSessionExpired(){const{sessionTimeoutMS:e}=this.config,t=this.date.now(),i=this.trafficSourceChanged();return!this.sessionId||t-this.lastActivity>e||i}trafficSourceChanged(){const e=this.trafficSourceService.getLastTrafficSource();return this.hashStore.changed("session_traffic_source",e)}refreshState(e){const t=e||this.storage.getJSON(this.KEY_SESSION_STATE)||this.state||{};return this.state=t,t}fetchSessionId(e=!1){if(this.sessionId&&!e)return this.sessionId;return this.startNewSession()}registerStorageChangeListeners(){this.storage.change(this.KEY_SESSION_ID).subscribe((e=>{e.value&&(this.sessionId=e.value)})),this.storage.change(this.KEY_DEVICE_ID,"full",this.storageChange).subscribe((e=>{e.value&&this.setState({device_id:e.value})})),this.storage.change(this.KEY_SESSION_STATE).subscribe((({value:e})=>this.refreshState(JSON.parse(e||"{}")))),this.storage.change(this.KEY_LAST_ACTIVITY).subscribe((({value:e})=>{const t=+(e||"0");(this.lastActivity||0)<t&&(this.lastActivity=t)}))}generateSessionId(){return`${this.date.now()}_${this.deviceIdService.getDeviceId()}`}}class NavigationEventService{constructor(e,t){this.tabOpenerDetector=e,this.env=t}send(e,t){const i=this.tabOpenerDetector.getOpener(!0),r={event:"navigation",pulse:"event",data:{initial:e,source:t,click_source:{}},event_priority:Tt.High};i?.element&&this.tabOpenerDetector.isFirstNavigation()&&e&&(r.data.click_source={section:i?.name,group:i?.group,tab_id:i?.id,url:i?.url,type:i?.type,element:{id:i?.element?.id,name:i?.element?.name,node_type:i?.element?.nodeName,class_list:i?.element?.classList}});const n=this.tabOpenerDetector.getTriggerEvent(e);!this.tabOpenerDetector.isFirstNavigation()&&n?.element&&(r.data.click_source={section:n?.name,group:n?.group,tab_id:n?.id,url:n?.url,element:{id:n?.element?.id,name:n?.element?.name,node_type:n?.element?.nodeName,class_list:n?.element?.classList}}),this.env.win.dataLayer?.push(r)}}class DeviceAttributesService{constructor(e,t,i,r,n,s,o,a){this.deviceInfoService=e,this.utmService=t,this.storage=i,this.date=r,this.config=n,this.sessionService=s,this.batchQueue=o,this.env=a,this.KEY_LAST_ATTRIBUTE_SYNC="attr",this.sessionService.newSessionGenerated$.subscribe((()=>{this.send(!0)}))}async send(e=!1){const t=this.getHints(),i=this.utmService.getUTMParams();(this.shouldSendHintsOld()||e)&&(this.env.win.dataLayer?.push({pulse:"attribute_hints",...t}),i&&this.env.win.dataLayer?.push({pulse:"attribute",...i}),this.queueState=this.batchQueue.queueEmpty$.subscribe((()=>{this.sent()})))}getHints(){return{...this.deviceInfoService.getScreenInfo(),...this.deviceInfoService.getHardwareInfo(),...this.deviceInfoService.getNavigatorInfo(),pa_open_time:Math.round(this.getOpenTime()/1e3)}}shouldSendHintsOld(){const e=+(this.storage.get(this.KEY_LAST_ATTRIBUTE_SYNC)||"0");return this.date.now()-e>this.config.attributeSyncIntervalMS}sent(){this.queueState?.unsubscribe(),this.storage.set(this.KEY_LAST_ATTRIBUTE_SYNC,this.date.now().toString())}getOpenTime(){const e=this.sessionService.getSession().sessionId.match(/^(\d+)_.*$/);let t=this.date.now();return e&&(t=Number(e[1])),t}}class AttributesCacheService{constructor(e,t,i,r){this.indexedDBService=e,this.quote=t,this.deviceIdService=i,this.dateService=r,this.attributesStorageKey="attributesStore",e.connectDB()}async getCachedAttributes(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"attributes");if(null!=e)return e}async getCachedHints(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"hints");if(null!=e)return e}async cacheAttributes(e,t=!1){const i=await this.quote.quoteSize(),r=(new TextEncoder).encode(JSON.stringify({id:"attributes",attributes:e,attributesSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-r>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"attributes",attributes:e,attributesSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async cacheHints(e,t=!1){const i=await this.quote.quoteSize(),r=(new TextEncoder).encode(JSON.stringify({id:"hints",hints:e,hintsSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-r>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"hints",hints:e,hintsSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async markSent(e){if("hints"===e){const e=await this.getCachedHints();e&&this.cacheHints(e.hints,!0)}if("attributes"===e){const e=await this.getCachedAttributes();e&&this.cacheAttributes(e.attributes,!0)}}}class PulseTracker{constructor(e,t,i,r,n,s,o,a,c){this.plugins=e,this.pipes=t,this.defaultPipes=i,this.logger=r,this.queue=n,this.sessionService=s,this.tabManagerService=o,this.date=a,this.config=c;const u=this.getContext();e.init(u)}event(e,t=Tt.Normal){this.events([e],t)}events(e,t=Tt.Normal){this.processMessages("event",e,t)}attribute(e,t=Tt.Normal){this.attributes([e],t)}attributes(e,t=Tt.Normal){this.processMessages("attribute",e,t)}attributeHint(e,t=Tt.Normal){this.processMessages("attribute-hint",[e],t)}set(e){"object"==typeof e&&e&&!Array.isArray(e)&&this.sessionService.setState(e)}cmd(e,...t){if(Array.isArray(e))return this.cmd(e[0],...e.slice(1));const i=e.split("."),r=this[PulseTracker.commandMap.get(i[1]||i[0]||"")||i[0]||""];"function"==typeof r?r.apply(this,t):this.logger.warn("Tracker",`Analytics command '${e}' not found!`)}flush(){this.queue.flush()}getContext(){return{config:this.config,session:this.sessionService.getSession(),tracker:this}}getTabId(){return this.tabManagerService.getTabId()}processMessages(e,t,i){const r=this.getContext(),n=t.map((t=>({type:e,data:JSON.parse(JSON.stringify(t)),priority:i,state:r.session.state,timestamp:this.date.now()}))).flatMap((e=>this.pipes.transform(e,r).map((e=>this.defaultPipes.transform(e,r))).flat().map((e=>this.defaultPipes.enrich(e,r))).map((e=>this.pipes.enrich(e,r)))));this.queue.push(...n)}}PulseTracker.commandMap=new Map([["event","event"],["send","event"],["attribute","attribute"],["attr","attribute"],["set","set"],["state","set"]]);class TrackerConfigurations extends CoreConfigurations{}const jt={...u,sessionTimeoutMS:18e5,attributeTimeoutMS:6048e5,attributeSyncIntervalMS:864e5,plugins:[],transformPipes:[],enrichmentPipes:[],consentChecks:[],serverCookies:!0,sessionStorageType:"persistent",attributesStorageType:"persistent",trafficSourceDetectorStorageType:"persistent",tabManagerStorageType:"tab",batchTimeMS:500,batchSize:100,serverBaseURL:"https://t.picsart.com/events/v1/web",eventEnrichment:!0,stateEnrichment:!0,attributeHints:!0,storagePrefix:"paa_"};function Ft(e,t,i){void 0===e&&(e=0),void 0===i&&(i=qt);var r=-1;return null!=t&&(Ie(t)?i=t:r=t),new Y((function(t){var n,s=(n=e)instanceof Date&&!isNaN(n)?+e-i.now():e;s<0&&(s=0);var o=0;return i.schedule((function(){t.closed||(t.next(o++),0<=r?this.schedule(void 0,r):t.complete())}),s)}))}function zt(e){return function(e){let t=e.length;for(let i=e.length-1;i>=0;i--){const r=e.charCodeAt(i);r>127&&r<=2047?t++:r>2047&&r<=65535&&(t+=2),r>=56320&&r<=57343&&i--}return t}(JSON.stringify(e))}function Vt(e,t){const i=[...e],r=[];let n=0;for(let s=0;s<i.length;s++){const e=Kt([i[s]],t),o=zt({chunks:e});if(o>6e4){r.push({chunks:e,keepAlive:!1,size:o}),i.splice(s,1),s-=1;continue}let a=i.slice(n,s+1),c=Kt(a,t),u=zt(c),h={chunks:c,keepAlive:!0,size:u};u>6e4?(a=i.slice(n,s),c=Kt(a,t),u=zt(c),h={chunks:c,keepAlive:!0,size:u},r.push(h),n=s):s===i.length-1&&r.push(h)}return r}function Kt(e,t){const i=new Map;for(const r of e){let e=i.get(r.state);e||(e=[],i.set(r.state,e)),e.push({...r,state:void 0,priority:void 0})}return Array.from(i).map((e=>({config:t,state:e[0],messages:e[1]})))}function $t(e){const t=Ge(e.stateEnrichment,"device_id"),i=Ge(e.stateEnrichment,"session_id"),r=Ge(e.eventEnrichment,"tab_id");return{deviceId:t?e.sessionStorageType:"none",sessionId:i?e.sessionStorageType:"none",tabId:r?e.tabManagerStorageType:"none",serverCookies:e.serverCookies}}class MessageQueue{constructor(e,t,i,r){this.consentService=e,this.config=t,this.batchQueue=i,this.visibility=r,this.messageReceived=new we,this.flushRequested=new we,this.queueEmpty$=i.queueEmpty$,this.batchConfig=$t(this.config),this.consentService.trackingEnabled().subscribe((e=>{this.trackingEnabled=e})),this.visibility.onVisibilityChange().subscribe((async e=>{!e&&this.trackingEnabled?(this.flush(),this.batchQueue.stopQueue()):e&&this.trackingEnabled&&this.batchQueue.startQueue()})),this.start()}push(...e){const t=e.some((e=>e.priority===Tt.Force)),i=e.some((e=>e.priority===Tt.High))||t;(this.trackingEnabled||t)&&(e.forEach((e=>this.messageReceived.next(e))),(i&&this.trackingEnabled||t)&&this.flushRequested.next())}flush(){this.flushRequested.next()}start(){const e=new we,t=e.pipe(function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Ae(e);return oe((function(t,r){(i?Dt(e,t,i):Dt(e,t)).subscribe(r)}))}({}),at((()=>{return void 0===(e=this.config.batchTimeMS)&&(e=0),void 0===t&&(t=Bt),e<0&&(e=0),Ft(e,e,t);var e,t}))),i=new ke(0),r=new we;i.pipe(be((e=>e===this.config.batchSize+1))).subscribe((()=>{r.next()}));const n=Nt([t,r,this.flushRequested]);var s;Re(this.messageReceived).pipe(Je((()=>i.next(i.value+1))),(s=n,oe((function(e,t){var i=[];return e.subscribe(ae(t,(function(e){return i.push(e)}),(function(){t.next(i),t.complete()}))),ne(s).subscribe(ae(t,(function(){var e=i;i=[],t.next(e)}),D)),function(){i=null}})))).subscribe((t=>{i.next(0),e.next(),this.pushToBatchQueue(t)})),i.next(0),r.next(),this.flushRequested.next(),e.next()}pushToBatchQueue(e){const t=Vt(e,this.batchConfig);t.length&&t.map((e=>this.batchQueue.pushBatch(e)))}}class BatchQueue{constructor(e,t,i,r,n,s,o){this.storage=e,this.lockManager=t,this.uuid=i,this.visibility=r,this.consentService=n,this.transport=s,this.config=o,this.batchQueue=[],this.sendingBatches=[],this.currentRequestSize=0,this.beaconLimit=6e4,this.queueProcessor=null,this.STORED_BATECHES_KEY="pulse-unpublished-events",this.queueEmpty$=new we,this.trackingEnabled&&this.queueStoredMessagesIfAny(),this.listenAndQueueOnStoreChanges(),this.consentService.trackingEnabled().subscribe((e=>{this.trackingEnabled=e})),this.batchConfig=$t(this.config)}pushBatch(e){const t=this.uuid.generate();this.visibility.visible?(this.batchQueue.push({batch:e,batchId:t}),this.queueProcessor||this.controlQueueProcessor()):(this.storeBatches([{batch:e,batchId:t}]),this.clearQueue(),this.sendStoredBatches())}startQueue(){this.queueStoredMessagesIfAny(),this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}async stopQueue(){if(this.stopQueueProcessor(),this.batchQueue.length){const e=this.batchQueue[0].batch.size||0;(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit)&&(this.currentRequestSize=this.currentRequestSize+e,this.sendBatch(this.batchQueue[0].batch,this.batchQueue[0].batchId).then((e=>this.handleResponse(e))).catch((e=>{console.error(e)})),this.sendingBatches.push(this.batchQueue[0]),this.batchQueue.splice(0,1))}this.storeBatches([...this.batchQueue]),this.clearQueue(),await Te(500),this.sendStoredBatches()}async queueStoredMessagesIfAny(){if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.queueStoredMessagesIfAny);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.queueStoredMessagesIfAny);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(this.storage.remove(this.STORED_BATECHES_KEY),this.lockManager.release(e),t.length){if("batchId"in t[0])t.forEach((e=>{this.batchQueue.some((t=>t.batchId===e.batchId))||this.batchQueue.push(e)}));else{Vt(t,this.batchConfig).forEach((e=>this.pushBatch(e)))}this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}}listenAndQueueOnStoreChanges(){this.storage.change(this.STORED_BATECHES_KEY).subscribe((async()=>{this.queueStoredMessagesIfAny()}))}storeBatches(e){const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[],i=e||[];this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t,...this.batchQueue,...i,...this.sendingBatches]))}clearQueue(){this.batchQueue=[]}controlQueueProcessor(){this.queueProcessor||(this.queueProcessor=setInterval((()=>{if(this.batchQueue.length||this.sendingBatches.length||(this.queueEmpty$.next(!0),this.currentRequestSize=0),0===this.batchQueue.length&&this.queueProcessor)return void this.stopQueueProcessor();const e=this.batchQueue[0].batch.size||0;if(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit){this.currentRequestSize+=e;const t=this.batchQueue.shift();t&&(this.sendingBatches.push(t),this.sendBatch(t.batch,t.batchId).then((e=>this.handleResponse(e))).catch((e=>console.error(e)))),0===this.batchQueue.length&&this.queueProcessor&&(this.sendingBatches.length||this.queueEmpty$.next(!0),this.stopQueueProcessor(),this.queueProcessor=null)}}),100))}stopQueueProcessor(){this.queueProcessor&&clearInterval(this.queueProcessor),this.queueProcessor=null}handleResponse({size:e,batchId:t}){this.currentRequestSize-=e;const i=this.sendingBatches.findIndex((e=>e.batchId===t));-1!==i&&this.sendingBatches.splice(i,1),this.sendingBatches.length||this.batchQueue.length||this.queueEmpty$.next(!0)}sendBatch(e,t){return new Promise((i=>{const r=!!e.keepAlive;delete e.keepAlive,this.transport.send(e,r,i,t)}))}async sendStoredBatches(){if(await Te(1e3),this.visibility.visible)return;if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.sendStoredBatches);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.sendStoredBatches);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(!t.length)return void this.lockManager.release(e);const i=t.splice(0,1);this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t])),this.lockManager.release(e),this.sendBatch(i[0].batch,i[0].batchId).then((()=>{this.visibility.visible||this.sendStoredBatches()})).catch((e=>{console.error(e)}))}postpone(e,t=1e3,i){setTimeout((()=>{e.call(this,i)}),t)}}class PipesFactory{constructor(e,t,i,r,n,s,o,a){this.attributeSpreadPipe=e,this.actionParamEventPipe=t,this.changedAttributesPipe=i,this.eventGlobalsPipe=r,this.sourcePipe=n,this.pipesHost=s,this.defaultPipesHost=o,this.config=a}registerPipes(){const e=this.config.transformPipes||[],t=this.config.enrichmentPipes||[],i=[{selector:"attribute",use:[this.attributeSpreadPipe,this.changedAttributesPipe]},{selector:"event",use:[this.actionParamEventPipe]}],r=[{selector:"event",use:[this.eventGlobalsPipe,this.sourcePipe]}];i.forEach((e=>this.defaultPipesHost.registerTransformSet(e))),r.forEach((e=>this.defaultPipesHost.registerEnrichmentSet(e))),e.forEach((e=>this.pipesHost.registerTransformSet(e))),t.forEach((e=>this.pipesHost.registerEnrichmentSet(e)))}}class DataLayerPlugin{constructor(e,t,i){this.dataLayer=e,this.commandPrefix=t,this.visibilityChangePlugin=i}init(e){if(this.tracker=e.tracker,!Array.isArray(this.dataLayer))throw new Error("DataLayer must be an array!");this.defaultPush=this.dataLayer.push.bind(this.dataLayer),this.dataLayer.push=this.onPush.bind(this),this.readFromBeginning()}onPush(...e){for(const t of e)this.processItem(t);return this.defaultPush?this.defaultPush(...e):0}readFromBeginning(){for(const e of this.dataLayer)this.processItem(e)}processItem(e){if(!this.tracker||"object"!=typeof e||!e)return;const t=e;if(this.isCommand(e)){const t=Array.from(e);this.tracker.cmd(t)}else if("event"===e.pulse){let i;e.event_priority&&(i=e.event_priority,delete t.event_priority);const r=this.normalize(e);this.tracker.event(r,i||(this.visibilityChangePlugin.visibilityState===kt.Hidden?Tt.High:Tt.Normal))}else if("attribute"===e.pulse){const t=this.normalize(e);this.tracker.attribute(t)}else if("attribute_hints"===e.pulse){const t=this.normalize(e);this.tracker.attributeHint(t)}else if("state"===e.pulse){const t=this.normalize(e);this.tracker.set(t)}else if("custom_event"===t.event||"custom_event_non_interaction"===t.event){const e=t.event_priority;t.event_priority&&delete t.event_priority,this.tracker.event(t.data,2===e?Tt.High:Tt.Normal)}}isCommand(e){return(Array.isArray(e)||"[object Arguments]"===Object.prototype.toString.call(e))&&"string"==typeof e[0]&&e[0].startsWith(this.commandPrefix)}normalize(e){const t={...e};return delete t.paa,t.pulse&&delete t.pulse,t}}class PluginsFactory{constructor(e,t,i,r,n,s,o,a,c,u,h,l,d,p,g,f){this.sessionStartPlugin=e,this.navigationEventPlugin=t,this.visibilityChangePlugin=i,this.clickEventPlugin=r,this.tabLinkingPlugin=n,this.statePlugin=s,this.deviceAttributesPlugin=o,this.consentEventPlugin=a,this.pluginHost=c,this.config=u,this.facebookPixelAttributePlugin=h,this.popupEventPlugin=l,this.contextMenuPlugin=d,this.internalDataLayer=p,this.rumPlugin=g,this.dataLayer=f}registerPlugins(){const e=[this.visibilityChangePlugin,this.clickEventPlugin,this.tabLinkingPlugin,this.statePlugin,this.sessionStartPlugin,this.navigationEventPlugin,this.deviceAttributesPlugin,this.consentEventPlugin,this.facebookPixelAttributePlugin,this.popupEventPlugin,this.rumPlugin,this.contextMenuPlugin,...this.config.plugins||[]];this.dataLayer&&e.push(new DataLayerPlugin(this.dataLayer,"paa.",this.visibilityChangePlugin)),this.internalDataLayer&&Array.isArray(this.internalDataLayer)&&e.push(new DataLayerPlugin(this.internalDataLayer,"",this.visibilityChangePlugin)),e.forEach((e=>this.pluginHost.register(e)))}}const Gt=new InjectionToken("DEFAULT_PIPES_HOST_TOKEN"),Qt=new InjectionToken("PIPES_HOST_TOKEN");function Yt(e){for(const t of e)if("object"==typeof t&&Array.isArray(t.name))for(let e=0;e<t.name.length;e++){const i=t.name[e];if("string"==typeof i&&i.startsWith("/")){const r=Et(i);r instanceof RegExp&&(t.name[e]=r)}}}const Jt=(new PulseModule).provide((function(e){return e.useFactory(TrackerConfigurations,(e=>e),[s]).useClass(OneTrustConsentService,OneTrustConsentService,[n]).useClass(TrackingConsentService,TrackingConsentService,[OneTrustConsentService,LoggerService,HashStore,TrackerConfigurations]).useClass(LegacySourceService,LegacySourceService,[UTMTrackerService,PageInfoService]).useClass(UTMTrackerService,UTMTrackerService,[PageInfoService]).useFactory(TrafficSourceService,((e,t,i,r)=>new TrafficSourceService(e,t(i.trafficSourceDetectorStorageType),r)),[UTMTrackerService,r,TrackerConfigurations,PageInfoService]).useFactory(SessionService,((e,t,i,r,n,s)=>new SessionService(e,t(n.sessionStorageType),i,r,n,s)),[DateService,r,TrafficSourceService,HashStore,TrackerConfigurations,DeviceIdService]).useFactory(NavigationEventService,((e,t)=>new NavigationEventService(e,t)),[TabOpenerDetector,AnalyticsEnvironment]).useClass(MessageQueue,MessageQueue,[TrackingConsentService,TrackerConfigurations,BatchQueue,DocumentVisibilityTracker]).useClass(AttributesCacheService,AttributesCacheService,[IndexedDBService,Quote,DeviceIdService,DateService]).useFactory(BatchQueue,((e,t,i,r,n,s,o)=>new BatchQueue(e("persistent"),t,i,r,n,s,o)),[r,LockManager,UUIDService,DocumentVisibilityTracker,TrackingConsentService,AnalyticsTransport,TrackerConfigurations]).useFactory(DeviceAttributesService,((e,t,i,r,n,s,o,a)=>new DeviceAttributesService(e,t,i("persistent"),r,n,s,o,a)),[DeviceInfoService,UTMTrackerService,r,DateService,TrackerConfigurations,SessionService,BatchQueue,AnalyticsEnvironment]).useClass(PluginHost,PluginHost,[]).useClass(Qt,PipeHost,[]).useClass(Gt,PipeHost,[]).useClass(AttributeSpreadPipe,AttributeSpreadPipe,[]).useClass(ActionParamEventPipe,ActionParamEventPipe,[]).useClass(ChangedAttributesPipe,ChangedAttributesPipe,[HashStore,TrackerConfigurations]).useClass(EventGlobalsPipe,EventGlobalsPipe,[LocationHistoryTracker,TabManagerService,PageInfoService,TrackerConfigurations,TabOpenerDetector,UUIDService]).useClass(LegacySourcePipe,LegacySourcePipe,[LegacySourceService,TrackerConfigurations]).useClass(VisibilityChangePlugin,VisibilityChangePlugin,[DocumentVisibilityTracker]).useClass(ClickEventPlugin,ClickEventPlugin,[ActivityTracker,AnalyticsEnvironment]).useClass(TabLinkingPlugin,TabLinkingPlugin,[ActivitySynchronizer,TabInfoService,TabManagerService,TrackerConfigurations]).useClass(NavigationEventPlugin,NavigationEventPlugin,[LocationHistoryTracker,NavigationEventService,SessionService,TrackingConsentService]).useClass(StatePlugin,StatePlugin,[SessionService,DebugService,TrackerConfigurations]).useClass(VisibilityChangePlugin,VisibilityChangePlugin,[DocumentVisibilityTracker]).useClass(PopupEventPlugin,PopupEventPlugin,[ActivityTracker,AnalyticsEnvironment]).useClass(DeviceAttributesPlugin,DeviceAttributesPlugin,[DeviceAttributesService]).useClass(ConsentEventPlugin,ConsentEventPlugin,[TrackingConsentService,SessionService,DeviceAttributesService,AnalyticsEnvironment]).useClass(FacebookPixelAttributePlugin,FacebookPixelAttributePlugin,[n,HashStore,DeviceAttributesService,AnalyticsEnvironment]).useClass(SessionStartEventPlugin,SessionStartEventPlugin,[HashStore,TrafficSourceService,SessionService,AnalyticsEnvironment]).useClass(RUMPlugin,RUMPlugin,[RUMService,AnalyticsEnvironment]).useClass(ContextMenuPlugin,ContextMenuPlugin,[ActivityTracker,AnalyticsEnvironment]).useClass(PluginsFactory,PluginsFactory,[SessionStartEventPlugin,NavigationEventPlugin,VisibilityChangePlugin,ClickEventPlugin,TabLinkingPlugin,StatePlugin,DeviceAttributesPlugin,ConsentEventPlugin,PluginHost,TrackerConfigurations,FacebookPixelAttributePlugin,PopupEventPlugin,ContextMenuPlugin,a,RUMPlugin,o]).useClass(PipesFactory,PipesFactory,[AttributeSpreadPipe,ActionParamEventPipe,ChangedAttributesPipe,EventGlobalsPipe,LegacySourcePipe,Qt,Gt,TrackerConfigurations]).useFactory(PulseTracker,((e,t,i,r,n,s,o,a,c,u,h)=>{c.registerPipes(),u.registerPlugins();return new PulseTracker(e,t,i,r,n,s,h,o,a)}),[PluginHost,Qt,Gt,LoggerService,MessageQueue,SessionService,DateService,TrackerConfigurations,PipesFactory,PluginsFactory,TabManagerService])})).beforeInit((function(e){const t={...jt,...e};return function(e){e.rumReport=e.rumReport||[],e.rumReportOnce=e.rumReportOnce||[],Yt(e.rumReport),Yt(e.rumReportOnce)}(t),"standard"!==t.mode&&(t.sessionStorageType="memory",t.attributesStorageType="memory",t.tabManagerStorageType="memory",t.trafficSourceDetectorStorageType="memory",t.eventEnrichment={tab_id:!1,legacy_source:!1,referrer:!1},t.stateEnrichment={device_id:!1,session_id:"page-session"===t.mode,market:!1,platform:!1},t.attributeHints=!1,t.serverCookies=!1),t})).onInit((async(e,t)=>{await t.connectDB()}),[IndexedDBService]);const Wt=window,Xt=Wt.pulseInit||[];Wt.pulseInit=Xt;const Zt=Xt.push.bind(Xt);function ei(e,t){if(t)return;const i=Xt.filter((t=>t.sdk===e));for(const r of i)Xt.splice(Xt.indexOf(r),1),r.onReady()}Xt.push=function(...e){for(const t of e)Wt.pulse?.tracker||Wt.pulse?.settingsFactory?t.onReady():Zt(t);return Xt.length};const ti=window,ii=ti.pulseReady||[];ti.pulseReady=ii;const ri=ii.push.bind(ii);function ni(e,t){if(t)return;const i=ii.filter((t=>t.sdk===e));for(const r of i)ii.splice(ii.indexOf(r),1),r.onReady()}ii.push=function(...e){for(const t of e)ri(t);return ii.length};const si=window,oi={"app":"picsart.com","storagePrefix":"paa_","batchTimeMS":500,"batchSize":50,"rumReport":["navigation","paint","largest-contentful-paint","longtask","first-input",{"entryType":"resource","name":["/optifyr\\.com/i"]},{"entryType":"mark","name":["/^pulse_/i"]},{"entryType":"measure","name":["/^pulse_/i"]},"layout-shift"],"rumReportOnce":[{"entryType":"resource","name":["/t\\.picsart\\.com/i"]}],"debug":[],"consentChecks":[{"type":"tracking","consent":"OneTrust","report":true,"mode":"opt-in"}]};async function ai(e){const t=si?.pulse;if(!t)throw new Error("Window.Pulse is not defined!");const i=t.initTask??async function(e){if(si?.pulse?._initialized&&si?.pulse?.tracker&&si?.pulse?.settingsFactory)return ei("tracker"),ei("settings"),{tracker:si.pulse.tracker,settingsFactory:si.pulse.settingsFactory};si.performance.mark("pulse_allInOneBundleInitStart");const t={...si.pulse?.c||{}||{},...e||{}},i=await(new PulseModule).import(St).import(Jt).import(_t).bootstrap(t),[r,n,s]=await Promise.all([i.get(PulseTracker),i.get(PulseSettings),i.get(PulseSettingsFactory)]);return si.performance.mark("pulse_allInOneBundleInitEnd"),si.performance.measure("pulse_allInOneBundleInitExecution","pulse_allInOneBundleInitStart","pulse_allInOneBundleInitEnd"),si.pulse.tracker=r,si.pulse.settings=n,si.pulse.settingsFactory=s,si.pulse._initialized=!0,ei("settings"),ei("tracker"),{tracker:r,settingsFactory:s}}(e);return t.initTask=i,await i,t?.tracker&&t?.settingsFactory&&(ei("settings"),ei("tracker")),i}si.pulse=function(e,t){if(e.pulse){if(1!==e.pulse._v)throw new Error("You can't load different versions of the Pulse SDK in a single page!");return e.pulse}function i(){i.q.push(arguments)}return e.pulseReady=e.pulseReady||[],e.pulseInit=e.pulseInit||[],e.dataLayer=e.dataLayer||[],i.c=t||{},i.q=[],i.idu=e.location.href,e.pulse=i,e.pulse._v=1,i}(si,oi),ai(oi),si.pulse.init=ai,ni("tracker"),ni("settings")})()})();
//# sourceMappingURL=pulse.bundle.all.esnext.9b4ae0d15a95af58.js.map