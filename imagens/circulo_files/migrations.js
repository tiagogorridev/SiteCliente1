!function(){"use strict";function a(){for(var a=arguments.length,t=new Array(a),e=0;e<a;e++)t[e]=arguments[e];return a=>t.reduce(((a,t)=>a.then(t)),Promise.resolve(a))}function t(t,e){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return t.currentVersion===t.targetVersion||t.currentVersion!==e.migrateFrom?t:a(...o,(r=e.migrateTo,a=>({...a,currentVersion:r})))(t);var r}let e=function(a){return a.apply="apply",a.configs="configs",a.interaction="interaction",a.bootstrapEditing="bootstrap-editing",a.bootstrapContent="bootstrap-content",a.bootstrapPublishing="bootstrap-publishing",a}({}),o=function(a){return a.close="close",a.bootstrap="bootstrap",a.deactivate="deactivate",a.customEvent="custom-event",a.redirectResponse="redirect-res",a.syncContext="sync-context",a.resolveMessage="resolve-message",a.openFileChooserResponse="chooser-res",a.refreshTokenResponse="refresh-token-res",a.remoteSettingsResponse="remote-settings-res",a.generateResultImageResponse="generate-result-image-res",a}({}),r=function(a){return a.select="select",a.apply="apply-res",a}({}),n=function(a){return a.error="error",a.ready="ready",a.close="close-res",a.redirect="redirect",a.analytics="analytics",a.download="download",a.downloadFile="export",a.saveState="save-state",a.openFileChooser="chooser",a.configureUi="configure-ui",a.syncContext="sync-context",a.refreshToken="refresh-token",a.customEvent="custom-event-res",a.getRemoteSettings="remote-settings",a.redirectToPackageId="redirect-to-package-id",a.generateResultImage="generate-result-image",a}({});const s=a=>a.action===o.bootstrap,i=a=>a.action===n.syncContext;let l=0;const d=()=>String((new Date).getTime()+l++),u=(a,t)=>{const e=d();return{id:e,resource:{id:e,source:"picsart",location:a,type:t}}},c=a=>{const{data:t}=a;if(i(t)){var e;const a={};null===(e=t.payload.images)||void 0===e||e.forEach((e=>{var o;let{layer:r}=e;if(null!==(o=t.payload.resources)&&void 0!==o&&o[r.url])return;const{id:n,resource:s}=u(r.url,"photo");a[n]=s,r.url=n})),t.payload.resources={...t.payload.resources,...a}}return a},p=a=>{const{data:t}=a;var e;(s(t)||(a=>a.action===o.openFileChooserResponse)(t)||i(t))&&(null===(e=t.payload.images)||void 0===e||e.forEach((a=>{var e;let{layer:o}=a;o.url=(null===(e=t.payload.resources)||void 0===e?void 0:e[o.url].location)||""})),delete t.payload.resources);return a},y=new Map([["Content",e.bootstrapContent],["Edit",e.bootstrapEditing],["Publish",e.bootstrapPublishing]]),v=a=>{const t=s(a.data)||i(a.data),{data:{payload:o}}=a;if(s(a.data)){var r;const t=Number((null===(r=a.data.payload.platformVersion)||void 0===r?void 0:r.split("v")[1])||0)<6;a.data.payload={...a.data.payload,platformVersion:t?"v5":a.data.payload.platformVersion,version:t?"v5-v4":a.data.payload.version},a.data.action=y.get(o.miniapp.extensions[0].type)}return i(a.data)&&(a.data.action=e.configs),t&&(window.currentPayload=a.data.payload),a},m=a=>{const t=window.currentPayload,{data:e}=a;if((a=>a.action===r.apply||a.action===r.select)(e)){var o,s;const a=null===(o=e.payload.images)||void 0===o?void 0:o[0],r=null===(s=e.payload.texts)||void 0===s?void 0:s[0],i=e.action===DeprecatedSendMessage.apply?t.selectedLayerIds[0]:d();a&&(a.layer.id=a.layer.id||i),r&&(r.layer.id=r.layer.id||i),e.payload.selectedLayerIds=[...t.selectedLayerIds],e.action===DeprecatedSendMessage.select?(e.payload.images=[...t.images],e.payload.texts=[...t.texts],a&&e.payload.images.push(a),r&&e.payload.texts.push(r)):(e.payload.images=t.images.map((t=>a&&t.layer.id===(null==a?void 0:a.layer.id)?{...a,...t,layer:{...t.layer,...a.layer}}:t)),e.payload.texts=t.texts.map((a=>r&&a.layer.id===(null==r?void 0:r.layer.id)?{...r,...a,layer:{...a.layer,...r.layer}}:a))),e.payload.videos=[],e.action=n.syncContext}return a},g=a=>(a.data.action===n.downloadFile&&(a.data.payload={...a.data.payload,...(a.data.payload.images||[]).reduce(((a,t)=>{const{id:e,resource:o}=u(t.layer.url,"photo");return a.images.push({...t,layer:{...t.layer,url:e}}),a.resources[e]=o,a}),{images:[],resources:{}})}),a);new URLSearchParams(window.location.search).get("platform");const f=new MessageChannel;let h=f.port2;const w=f.port1,k={current:()=>{}};new Promise((a=>{k.current=a})),window.addEventListener("message",(a=>{if("capturePort"===a.data)null!==a.ports[0]&&(h=a.ports[0],k.current());else try{"string"==typeof a.data&&w.postMessage(JSON.parse(a.data))}catch(a){console.log(a)}})),w.start(),h.start();const b=window.navigator.userAgent.toLowerCase(),x=/android/.test(b),P=()=>{return!(null===(a=window.webkit)||void 0===a||!a.messageHandlers.bridge)||x&&/; wv\)/.test(b);var a},C=a=>"sticker"===a.type,I=["http://","https://","blob:","data:"],F=a=>P()&&I.some((t=>a.startsWith(t))),T=[],V=[],E=()=>{if(V.length<=6&&T.length){const a=T.shift();if(a){const t=a();V.push(t),t.then((()=>{V.splice(V.indexOf(t),1),E()}))}}};var S,U=(S=async(a,t)=>{const e=new FormData;return e.append("image",t,a),(await fetch("".concat("https://localhost:4000","/storage"),{method:"POST",body:e})).ok},function(){for(var a=arguments.length,t=new Array(a),e=0;e<a;e++)t[e]=arguments[e];return new Promise(((a,e)=>{T.push((async()=>{try{const e=await S(...t);a(e)}catch(a){e(a)}})),E()}))});const L=async a=>fetch(a).then((a=>a.blob())).then((async a=>{const t="".concat(d(),".").concat(a.type.split("/")[1]);return await U(t,a),t})),R=async a=>{const{data:t}=a;return s(t)&&await Promise.all((t.payload.images||[]).map((a=>{const{layer:t}=a,e=[];return F(t.url)&&e.push(L(t.url).then((a=>t.url===a))),t.maskUrl&&F(t.maskUrl)&&e.push(L(t.maskUrl).then((a=>t.maskUrl===a))),Promise.all(e)}))),a};const _={position:{x:.5,y:.5},rotation:0,scale:1,aspect_scale:1,scale_type:"fit",flipped:{horizontal:!1,vertical:!1},position_space:"self"},O={opacity:0},M={manual:!1,inverted:!1,shapes:[]},N={pattern:O,width:0,linecap:"butt",linejoin:"round"},J={photo:"",transform:_,opacity:100,blendmode:"normal",stroke:N},j={sticker:"",transform:_,opacity:100,blendmode:"normal",stroke:N},A={text:"",lines:[],alignment:"center",letter_spacing:1,line_spacing:1,bend:0,fill:O,opacity:100,transform:_,blendmode:"normal",format:[],perspective_points:[]},D={video:"",transform:_,blendmode:"normal",visible:!0,start_time:0,duration:-1,trim_start:0,trim_end:-1,volume:100};function z(a){var t,e,o,r;if(!i(a.data))return a;const n=window.v6CurrentPayload||{},s=[],l=[];null===(t=a.data.payload.images)||void 0===t||t.forEach((a=>{const t=function(a){const t=window.v6CurrentPayload||{};return!!t.stickers&&t.stickers.some((t=>t.uuid===a.layer.id))}(a);if(t){var e,o,r;const t=null===(e=n.stickers)||void 0===e?void 0:e.find((t=>{let{uuid:e}=t;return e===a.layer.id})),s=(null==t||null===(o=t.settings)||void 0===o?void 0:o.sticker)!==a.layer.url||(null==t||null===(r=t.settings)||void 0===r||null===(r=r.mask)||void 0===r?void 0:r.mask)!==a.layer.maskUrl;l.push({uuid:a.layer.id,type:"sticker",settings:{...(null==t?void 0:t.settings)||j,sticker:a.layer.url,mask:{...M,mask:a.layer.maskUrl}},meta:{...(null==t?void 0:t.meta)||{},...s&&{miniappPackageId:n.miniapp.packageId}}})}else{var i,d,u;const t=null===(i=n.images)||void 0===i?void 0:i.find((t=>{let{uuid:e}=t;return e===a.layer.id})),e=(null==t||null===(d=t.settings)||void 0===d?void 0:d.photo)!==a.layer.url||(null==t||null===(u=t.settings)||void 0===u||null===(u=u.mask)||void 0===u?void 0:u.mask)!==a.layer.maskUrl;s.push({uuid:a.layer.id,type:"photo",settings:{...(null==t?void 0:t.settings)||J,photo:a.layer.url,mask:{...M,mask:a.layer.maskUrl}},meta:{...(null==t?void 0:t.meta)||{},...e&&{miniappPackageId:n.miniapp.packageId}}})}}));const d=null===(e=a.data.payload.texts)||void 0===e?void 0:e.map((a=>{var t,e,o;const r=null===(t=n.texts)||void 0===t?void 0:t.find((t=>{let{uuid:e}=t;return e===a.layer.id})),s=(null==r||null===(e=r.settings)||void 0===e?void 0:e.text)!==a.layer.text||(null==r||null===(o=r.settings)||void 0===o?void 0:o.font)!==a.layer.font;return{uuid:a.layer.id,type:"text",meta:{...(null==r?void 0:r.meta)||{},...s&&{miniappPackageId:n.miniapp.packageId}},settings:{...(null==r?void 0:r.settings)||A,text:a.layer.text,font:a.layer.font}}}));return null===(o=a.data.payload.texts)||void 0===o||o.forEach((t=>{var e;const o=t.layer.font||"",r=null===(e=a.data.payload.resources)||void 0===e?void 0:e[o];r&&(r.type="font")})),null===(r=a.data.payload.images)||void 0===r||r.forEach((t=>{var e;const o=t.layer.url||"",r=null===(e=a.data.payload.resources)||void 0===e?void 0:e[o];r&&(r.type="photo")})),Object.values(a.data.payload.resources||{}).forEach((a=>{a.type=a.type||""})),a.data.payload.images=s,a.data.payload.texts=d,a.data.payload.stickers=l,a.data.payload.resources=a.data.payload.resources||{},a.data.payload.selectedLayerIds=a.data.payload.selectedLayerIds||[],a.data.payload.shapes=a.data.payload.shapes||[],a.data.payload.videos=a.data.payload.videos||[],a}const H=(a,t)=>{const e=C(a)?a.settings.sticker:a.settings.photo,o=t.data.payload.resources;if(o&&o[e]&&o[e].location){const a=o[e].location.split(".").pop();return"png"===(null==a?void 0:a.toLocaleLowerCase())?"image/png":"image/jpeg"}return"image/jpeg"};function W(a){var t,e;const o=null===(t=[...a.data.payload.images||[],...a.data.payload.stickers||[]])||void 0===t?void 0:t.map((t=>{var e;const o={layer:{id:t.uuid,url:C(t)?t.settings.sticker:t.settings.photo},mimeType:H(t,a)};return null!==(e=t.settings.mask)&&void 0!==e&&e.mask&&(o.layer.maskUrl=t.settings.mask.mask),o})),r=null===(e=a.data.payload.texts)||void 0===e?void 0:e.map((a=>({layer:{text:a.settings.text,font:a.settings.font,id:a.uuid,fontFamily:""},mimeType:"text/plain"})));return a.data.payload.images=o,a.data.payload.texts=r,a}function q(a){return a.data.action===n.openFileChooser&&(a.data.payload.maxCount=a.data.payload.multiSelectEnabled?10:1),a}function B(a){const t=s(a.data)||i(a.data);return s(a.data)&&(a.data.payload={...a.data.payload,platformVersion:"v6",version:"v6-v5"}),t&&(window.v6CurrentPayload={...window.v6CurrentPayload||{},...JSON.parse(JSON.stringify(a.data.payload))}),a.data.payload={...window.v6CurrentPayload||{},...a.data.payload},a}function G(a){const t=s(a.data)||i(a.data);return s(a.data)&&(a.data.payload={...a.data.payload,platformVersion:"v7",version:"v7-v6"}),t&&(window.v7CurrentPayload={...window.v7CurrentPayload||{},...JSON.parse(JSON.stringify(a.data.payload))}),a.data.payload={...window.v7CurrentPayload||{},...a.data.payload},a}function K(a){var t;return a.data.payload.videos=null===(t=a.data.payload.videos||[])||void 0===t?void 0:t.map((a=>({layer:{id:a.uuid,url:a.settings.video},mimeType:"video/mp4"}))),a}function Q(a){var t;if(!i(a.data))return a;const e=window.v7CurrentPayload||{},o=[];return null===(t=a.data.payload.videos)||void 0===t||t.forEach((a=>{var t,r;const n=null===(t=e.videos)||void 0===t?void 0:t.find((t=>{let{uuid:e}=t;return e===a.layer.id})),s=(null==n||null===(r=n.settings)||void 0===r?void 0:r.video)!==a.layer.url;o.push({uuid:a.layer.id,type:"video",settings:{...(null==n?void 0:n.settings)||D,video:a.layer.url},meta:{...(null==n?void 0:n.meta)||{},...s&&{miniappPackageId:e.miniapp.packageId}}})})),{...a,data:{...a.data,payload:{...a.data.payload,videos:o}}}}const X=a((function(a){return t(a,{migrateFrom:"v4",migrateTo:"v5"},[m,g,c])}),(function(a){return t(a,{migrateFrom:"v5",migrateTo:"v6"},[q,z])}),(function(a){return t(a,{migrateFrom:"v6",migrateTo:"v7"},[Q])})),Y=a((function(a){return t(a,{migrateFrom:"v7",migrateTo:"v6"},[G,K])}),(function(a){return t(a,{migrateFrom:"v6",migrateTo:"v5"},[B,W])}),(function(a){return t(a,{migrateFrom:"v5",migrateTo:"v4"},[p,R,v])}));window.runPrivateAPIMigrations=async(a,t)=>{let{send:e,platformVersion:o,sdkVersion:r}=t;return e?e?(await X({data:a,currentVersion:r,targetVersion:o})).data:a:(await Y({data:a,currentVersion:o,targetVersion:r})).data}}();